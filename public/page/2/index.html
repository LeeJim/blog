<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Jim Home</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="leejimqiu"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="leejimqiu"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="技术博客，前端开发，微信小程序，VSCode"><meta property="og:type" content="blog"><meta property="og:title" content="Jim Home"><meta property="og:url" content="http://africans.com/"><meta property="og:site_name" content="Jim Home"><meta property="og:description" content="技术博客，前端开发，微信小程序，VSCode"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://africans.com/img/og_image.png"><meta property="article:author" content="leejimqiu"><meta property="article:tag" content="leejimqiu,"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://africans.com"},"headline":"Jim Home","image":["http://africans.com/img/og_image.png"],"author":{"@type":"Person","name":"leejimqiu"},"publisher":{"@type":"Organization","name":"Jim Home","logo":{"@type":"ImageObject","url":"http://africans.com/img/logo.svg"}},"description":"技术博客，前端开发，微信小程序，VSCode"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?6638f74329d0f52c5cdafdadb58010af";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Jim Home" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/leejim"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-23T06:36:46.000Z" title="5/23/2020, 2:36:46 PM">2020-05-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:36:46.000Z" title="5/23/2020, 2:36:46 PM">2020-05-23</time></span><span class="level-item">9 minutes read (About 1323 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/23/mini-program/api-promisify/">API Promise化</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>众所周知，前端一大坑就是回调函数。</p>
<p>相信很多人是从<code>async/await</code>的温柔乡，掉到小程序重新写回调的大坑里的。</p>
<p>由于开发者工具新增了 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/codecompile.html">增强编译</a> 从而原生支持了<code>async\await</code>，避免了我们仍需通过webpack等第三方打包工具实现。因此我们需要做的就是将官方API的 <strong>异步调用</strong> 方式改成 <strong>Promise的方式</strong> 即可。</p>
<h2 id="分析与实践"><a href="#分析与实践" class="headerlink" title="分析与实践"></a>分析与实践</h2><p>大致上可以有两种思路，第一种就是，逐个函数封装：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promisify = <span class="function"><span class="params">func</span> =&gt;</span> <span class="function"><span class="params">args</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    func(<span class="built_in">Object</span>.assign(args, &#123;</span><br><span class="line">        <span class="attr">success</span>: resolve,</span><br><span class="line">        <span class="attr">fail</span>: reject,</span><br><span class="line">    &#125;))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _login = promisify(wx.login) <span class="comment">// 将wx.login转成Promise形式的方法</span></span><br><span class="line"></span><br><span class="line">_login().then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<p>这种方式比较麻烦，每次调用都需要手动转换。</p>
<h3 id="劫持WX"><a href="#劫持WX" class="headerlink" title="劫持WX"></a>劫持WX</h3><p>第二种就类似<code>Page</code>封装那样，劫持<code>wx</code>对象，进行全局统一封装。但有一点比较棘手的是，需要分析清楚哪些是函数，哪些函数是异步而不是同步的，一开始我的思路是这样的：</p>
<ul>
<li>同步方法是以<code>Sync</code>结尾的</li>
<li>通过<code>typeof</code>判断是否为函数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// promisify.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> originalWX = wx</span><br><span class="line"><span class="keyword">let</span> props = <span class="built_in">Object</span>.keys(wx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">of</span> props) &#123;</span><br><span class="line">    <span class="keyword">let</span> fn = wx[name]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn === <span class="string">&#x27;function&#x27;</span> &amp;&amp; !name.endsWith(<span class="string">&#x27;Sync&#x27;</span>)) &#123;</span><br><span class="line">        wx[name] = promisify(fn)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尝试封装之后，发现报错了。因为<code>wx.drawCanvas</code>只有<code>getter</code>没有<code>setter</code>，无法给它赋值。相当于这个方法是<code>readonly</code>。</p>
<p><img src="/images/promisify-error1.jpg"></p>
<p>既然存在没有<code>setter</code>的方法，那么我看有多少方法是有<code>setter</code>的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.keys(wx).filter(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(wx, name)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> descriptor.set === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>结果是<code>[]</code>，相当于无法改变<code>wx</code>对象的每个属性值。</p>
<p><img src="/images/promisify-console1.jpg"></p>
<h3 id="复制模式"><a href="#复制模式" class="headerlink" title="复制模式"></a>复制模式</h3><p>虽然<code>wx</code>的属性都是<code>readonly</code>，不能劫持<code>wx</code>，但我发现<code>wx</code>是<code>writable</code>的。</p>
<p>那么可以采用复制模式，将它的所有异步方法拷贝一份并<code>promisify</code>之后赋值到新对象，最后再将整个对象赋值给<code>wx</code>即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> props = <span class="built_in">Object</span>.keys(wx)</span><br><span class="line"><span class="keyword">let</span> jwx = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">of</span> props) &#123;</span><br><span class="line">    <span class="keyword">let</span> fn = wx[name]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn === <span class="string">&#x27;function&#x27;</span> &amp;&amp; !name.endsWith(<span class="string">&#x27;Sync&#x27;</span>)) &#123;</span><br><span class="line">        jwx[name] = promisify(fn)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jwx[name] = fn</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wx = jwx</span><br></pre></td></tr></table></figure>

<p>这种方式虽可行，但是挺冗余的，因为将很多可能没用上的方法也进行了<code>promisify</code>。</p>
<h3 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h3><p>熟悉ES新特性的读者应该知道<code>Proxy</code>。</p>
<p>它可以用来定义对象的自定义行为，顾名思义，就是给对象挂上<code>Proxy</code>之后，对这个属性的任何行为都可以被代理。</p>
<p>那么我们就可以给<code>wx</code>挂上代理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> originalWX = wx</span><br><span class="line">wx = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, name</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name <span class="keyword">in</span> originalWX ) &#123;</span><br><span class="line">            <span class="keyword">let</span> fn = originalWX[name]</span><br><span class="line">            <span class="keyword">let</span> isSyncFunc = name.endsWith(<span class="string">&#x27;Sync&#x27;</span>) <span class="comment">// 同步函数 </span></span><br><span class="line">            <span class="keyword">let</span> isNotFunc = <span class="keyword">typeof</span> fn !== <span class="string">&#x27;function&#x27;</span> <span class="comment">// 非函数</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isSyncFunc || isNotFunc) <span class="keyword">return</span> fn</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> promisify(fn)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>代理的方式虽解决了复制模式的冗余问题，但是仍有一个问题待解决：异步方法的判断。</p>
<p>在实践中，我发现并不是所有同步方法都是以<code>Sync</code>结尾的。比如：<code>wx.getMenuButtonBoundingClientRect</code>。</p>
<p>因此打算手动维护一个同步方法列表，将这项方法过滤掉：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> syncFuncList = [<span class="string">&#x27;getMenuButtonBoundingClientRect&#x27;</span>]</span><br><span class="line"><span class="comment">// name为函数名</span></span><br><span class="line"><span class="keyword">let</span> isSync = name.endsWith(<span class="string">&#x27;Sync&#x27;</span>) || syncFuncList.includes(name)</span><br></pre></td></tr></table></figure>


<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>考虑到要兼容已上线的小程序，若匆忙替换<code>wx</code>，必会导致全局报错，因此可以如下处理：</p>
<p>当用户调用API时，如果传入了<code>success</code>、<code>fail</code>、<code>complete</code>等回调方法的话，则仍继续使用回调的方式继续执行。那么<code>promisify</code>可以如下优化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> originalWX = wx</span><br><span class="line"><span class="keyword">let</span> hasCallback = <span class="function"><span class="params">obj</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> cbs = [<span class="string">&#x27;success&#x27;</span>, <span class="string">&#x27;fail&#x27;</span>, <span class="string">&#x27;complete&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.keys(obj).some(<span class="function"><span class="params">k</span> =&gt;</span> cbs.includes(k))</span><br><span class="line">&#125;</span><br><span class="line">wx = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, name</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name <span class="keyword">in</span> originalWX ) &#123;</span><br><span class="line">            <span class="keyword">let</span> fn = originalWX[name]</span><br><span class="line">            <span class="keyword">let</span> isSyncFunc = name.endsWith(<span class="string">&#x27;Sync&#x27;</span>) <span class="comment">// 同步函数 </span></span><br><span class="line">            <span class="keyword">let</span> isNotFunc = <span class="keyword">typeof</span> fn !== <span class="string">&#x27;function&#x27;</span> <span class="comment">// 非函数</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isSyncFunc || isNotFunc) <span class="keyword">return</span> fn</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!obj) <span class="keyword">return</span> fn()</span><br><span class="line">                <span class="keyword">if</span> (hasCallback(obj)) <span class="keyword">return</span> fn(obj)</span><br><span class="line">                <span class="keyword">return</span> promisify(fn)(obj)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于本文的前提是开启 <strong>增强编译</strong>，而该模式下也新增支持<code>Array.prototype.includes</code>，因此可以放心使用该ES7的新特性。</p>
</blockquote>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>由于发现了微信官方也提供了一个 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/extended/utils/api-promise.html">API Promise化</a> 的工具类库，因此增加了本章节。</p>
<p>通过阅读源代码，发现官方的工具类库提供两个方法：<code>promisify</code> 和 <code>promisifyAll</code></p>
<p>其中<code>promisify</code>与前文的同名方法是几乎一致的。而<code>promisifyAll</code>则是接收两个参数，第一个是被封装的对象，第二个则是封装之后的对象，如下使用将和前文我提到的封装方式类似：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; promisifyAll &#125; <span class="keyword">from</span> <span class="string">&#x27;miniprogram-api-promise&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> jwx = &#123;&#125;</span><br><span class="line"></span><br><span class="line">promisifyAll(wx, jwx)</span><br><span class="line"></span><br><span class="line">wx = jwx</span><br></pre></td></tr></table></figure>

<p>另外还有一点需要提到的是，官方这个工具类库，判断是否为异步函数的方式是维护了一个异步方法列表，会存在遗漏新API的可能。</p>
<p>相当于我的做法是黑名单机制，而官方采用了白名单机制。</p>
<blockquote>
<p>最后再提醒下，开发者工具记得打开 <strong>增强编译</strong></p>
</blockquote>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-01-07T14:54:42.000Z" title="1/7/2018, 10:54:42 PM">2018-01-07</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-01-18T15:13:58.000Z" title="1/18/2018, 11:13:58 PM">2018-01-18</time></span><span class="level-item">5 minutes read (About 691 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/01/07/practice-of-wxapp-1/">小程序实战汇总一</a></h1><div class="content"><p>随着小程序的能力越来越强，逐渐得到越来越多用户的认可，因此对小程序的需要也越来越大。</p>
<p>那么总结一下小程序的开发实践还是蛮有意义的一件事，希望能帮助大家，可以让大家避免走弯路。</p>
<h1 id="授权处理"><a href="#授权处理" class="headerlink" title="授权处理"></a>授权处理</h1><p>在小程序中，最常见的场景就是授权处理。在小程序刚推出的时候，这个流程也还不完善，对于拒绝授权的用户将无法正常使用小程序。</p>
<p>因为拒绝授权的用户，几分钟内是默认拒绝的，尽管你一再地调用授权的接口。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>在基础库<strong>1.2</strong>版本，新增了<code>wx.getSetting</code>接口，可以获取到用户的当前设置，利用这个接口可以实现二次授权。</p>
<p>具体实现可参考一下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">wx.getUserInfo(&#123;</span><br><span class="line">  <span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 成功获取用户信息，继续操作</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">fail</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    wx.showModal(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;用户未授权&#x27;</span>,</span><br><span class="line">      <span class="attr">content</span>: <span class="string">&#x27;如需正常使用清单同步功能，请按确认并在授权管理中选中“用户信息”，是否重新授权登录？&#x27;</span>,</span><br><span class="line">      <span class="attr">success</span>: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (action.confirm) &#123;</span><br><span class="line">          </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查状态</span></span><br><span class="line">wx.openSetting(&#123;</span><br><span class="line">  <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 二次授权成功</span></span><br><span class="line">    <span class="keyword">if</span> (res.authSetting[<span class="string">&quot;scope.userInfo&quot;</span>]) &#123;</span><br><span class="line">      <span class="comment">// 成功获取用户信息</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">fail</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    fail()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="页面数据传递"><a href="#页面数据传递" class="headerlink" title="页面数据传递"></a>页面数据传递</h1><p>页面之间的数据传递是很常见的，那么在小程序中能如何传递数据呢？</p>
<h2 id="URL传递"><a href="#URL传递" class="headerlink" title="URL传递"></a>URL传递</h2><p>类似Web的链接跳转，使用类似query串的形式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wx.navigateTo(<span class="string">&#x27;../user/user?name=leejim&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>在目的页的<code>onload</code>函数，可以这么获取：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">onLoad</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(options.name) <span class="comment">// leejim</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用客户端缓存"><a href="#使用客户端缓存" class="headerlink" title="使用客户端缓存"></a>使用客户端缓存</h2><p>小程序提供了本地存储的方式：<code>wx.setStorage</code>和<code>wx.getStorage</code>。</p>
<p>可以在页面跳转前，先用<code>wx.setStorage</code>缓存数据，然后在目的页使用<code>wx.getStorage</code>获取数据。</p>
<h2 id="使用全局变量"><a href="#使用全局变量" class="headerlink" title="使用全局变量"></a>使用全局变量</h2><p>在小程序里，有一个全局函数<code>getApp</code>用来获取全局变量<code>app</code>。</p>
<p>比如这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = getApp()</span><br><span class="line">app.index = <span class="number">1</span> <span class="comment">// 设置变量</span></span><br></pre></td></tr></table></figure>

<h2 id="往栈内的页面传递数据"><a href="#往栈内的页面传递数据" class="headerlink" title="往栈内的页面传递数据"></a>往栈内的页面传递数据</h2><p>使用全局函数<code>getCurrentPages</code>函数可以获取栈内的所有页面。</p>
<p>然后就可以直接设置那个页面的数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pages = getCurrentPages()</span><br><span class="line">pages[pages.length -<span class="number">1</span>].setData(&#123; <span class="comment">// 往前一个页面设置数据</span></span><br><span class="line">  <span class="attr">data</span>: <span class="number">123</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="修改Input组件的值"><a href="#修改Input组件的值" class="headerlink" title="修改Input组件的值"></a>修改Input组件的值</h1><p>因为小程序实现的是单向绑定，而且去除了原有DOM的操作，导致我们无法用常规的方式去操作input的值。</p>
<p>但是我们能通过data绑定的方式来实现：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#x27;&#123;&#123;inputValue&#125;&#125;&#x27;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>js部分：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.setData(&#123;</span><br><span class="line">  <span class="attr">inputValue</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-11-11T02:53:38.000Z" title="11/11/2017, 10:53:38 AM">2017-11-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:10:30.000Z" title="5/23/2020, 2:10:30 PM">2020-05-23</time></span><span class="level-item">4 minutes read (About 551 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/11/what-is-bfc/">我所理解的BFC</a></h1><div class="content"><h1 id="BFC"><a href="#BFC" class="headerlink" title="BFC"></a>BFC</h1><p>BFC (Block Formatting Context) <strong>块级格式化上下文</strong>，在W3C上是这么定义的：</p>
<blockquote>
<p>Floats, absolutely positioned elements, block containers (such as inline-blocks, table-cells, and table-captions) that are not block boxes, and block boxes with ‘overflow’ other than ‘visible’ (except when that value has been propagated to the viewport) establish new block formatting contexts for their contents.<br>In a block formatting context, boxes are laid out one after the other, vertically, beginning at the top of a containing block. The vertical distance between two sibling boxes is determined by the ‘margin’ properties. Vertical margins between adjacent block-level boxes in a block formatting context collapse.<br>In a block formatting context, each box’s left outer edge touches the left edge of the containing block (for right-to-left formatting, right edges touch). This is true even in the presence of floats (although a box’s line boxes may shrink due to the floats), unless the box establishes a new block formatting context (in which case the box itself may become narrower due to the floats).<br>For information about page breaks in paged media, please consult the section on allowed page breaks.</p>
</blockquote>
<h2 id="BFC效果"><a href="#BFC效果" class="headerlink" title="BFC效果"></a>BFC效果</h2><p>先来说说BFC有什么效果，从效果看本质。</p>
<p>逐个翻译W3c的定义如下：</p>
<ul>
<li><code>boxes</code>按顺序，从上到下，垂直排列</li>
</ul>
<blockquote>
<p>boxes are laid out one after the other, vertically, beginning at the top of a containing block</p>
</blockquote>
<ul>
<li>相邻<code>boxes</code>的垂直距离由margin决定，但是在同一个BFC容器的话，<code>margin</code>会合并</li>
</ul>
<blockquote>
<p>The vertical distance between two sibling boxes is determined by the ‘margin’ properties. Vertical margins between adjacent block-level boxes in a block formatting context collapse.</p>
</blockquote>
<ul>
<li>每个<code>boxes</code>的左边会和BFC容器的左边重叠，<code>float</code>元素也是如此</li>
</ul>
<blockquote>
<p>each box’s left outer edge touches the left edge of the containing block (for right-to-left formatting, right edges touch). This is true even in the presence of floats (although a box’s line boxes may shrink due to the floats), </p>
</blockquote>
<ul>
<li>可以解决因<code>float</code>元素导致的高度收缩问题（也就是常说的消除浮动）</li>
</ul>
<blockquote>
<p> This is true even in the presence of floats (although a box’s line boxes may shrink due to the floats), unless the box establishes a new block formatting context (in which case the box itself may become narrower due to the floats).</p>
</blockquote>
<h2 id="如何触发BFC"><a href="#如何触发BFC" class="headerlink" title="如何触发BFC"></a>如何触发BFC</h2><ul>
<li><code>float</code>元素和 absolutely元素 (例如<code>position: absolute||fixed</code>) </li>
<li><code>display</code>等于<code>inline-blocks</code>, <code>table-cells</code>, and <code>table-captions</code>的块级容器元素</li>
<li><code>overflow</code>不等于<code>visible</code>的元素</li>
</ul>
<h2 id="BFC作用"><a href="#BFC作用" class="headerlink" title="BFC作用"></a>BFC作用</h2><ul>
<li><p>相邻margin合并的问题</p>
</li>
<li><p>消除浮动</p>
</li>
</ul>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.html-js.com/article/1866">CSS之BFC详解</a></li>
<li><a target="_blank" rel="noopener" href="https://www.w3.org/TR/CSS2/visuren.html#block-formatting">W3C block-formatting</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-11-05T10:43:13.000Z" title="11/5/2017, 6:43:13 PM">2017-11-05</time></span><span class="level-item">Updated&nbsp;<time dateTime="2017-12-15T03:05:40.000Z" title="12/15/2017, 11:05:40 AM">2017-12-15</time></span><span class="level-item">4 minutes read (About 561 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/05/what-is-cookie/">什么是cookie</a></h1><div class="content"><p>起源，因为HTTP的无状态，无法知道两个请求是来自同个人。</p>
<p>由NetScape工程师Lou Montulli与1994发表。正式确定于<a target="_blank" rel="noopener" href="http://tools.ietf.org/html/rfc2109">RFC2109</a>，最终演变成<a target="_blank" rel="noopener" href="http://tools.ietf.org/html/rfc2965">RFC2965</a></p>
<h2 id="Cookie为何物？"><a href="#Cookie为何物？" class="headerlink" title="Cookie为何物？"></a>Cookie为何物？</h2><p>简单说，就是一个简单的纯文本。服务器可根据这个文本来区别每个独立的用户。因此，cookie经常被应用于登录和信息校验。</p>
<h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><p>服务器通过<code>Set-Cookie</code>的HTTP头来设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: &lt;em&gt;value&lt;/em&gt;[; expires=&lt;em&gt;date&lt;/em&gt;][; domain=&lt;em&gt;domain&lt;/em&gt;][; path=&lt;em&gt;path&lt;/em&gt;][; secure]</span><br></pre></td></tr></table></figure>

<p>客户端将多个cookie通过<code>Cookie</code>的HTTP头来返回服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: value1; value2; name1=value1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>多个value直接由一个分号和一个空格分隔开</p>
</blockquote>
<h3 id="value编码"><a href="#value编码" class="headerlink" title="value编码"></a>value编码</h3><p>在普遍持有的观念中，value一定要是<code>URL-endcoed</code>编码的。</p>
<p>其实这是个谬论，在文档中，明确指出只有<code>分号、逗号、空格</code>才需要编码。</p>
<h3 id="expires"><a href="#expires" class="headerlink" title="expires"></a>expires</h3><p>设置过期时间。需要使用GMT格式的时间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: name=Nicholas; expires=Sat, 02 May 2009 23:38:25 GMT</span><br></pre></td></tr></table></figure>

<blockquote>
<p>若没设置时间，则一个会话周期（即关闭浏览器）就会自动被删除</p>
</blockquote>
<blockquote>
<p>校验的时间是以客户端的时间为准</p>
</blockquote>
<h3 id="domain"><a href="#domain" class="headerlink" title="domain"></a>domain</h3><p>指定什么域名请求时需要发送该cookie。</p>
<blockquote>
<p>采用尾校验，即子域名也会发送(domain=yahoo.com，在my.yahoo.com也会发送)</p>
</blockquote>
<h3 id="path"><a href="#path" class="headerlink" title="path"></a>path</h3><p>指定域名下的对应路径的请求才发送cookie。</p>
<h3 id="secure"><a href="#secure" class="headerlink" title="secure"></a>secure</h3><p>有这个标志，cookie只会在HTTPS协议的请求发送该cookie。</p>
<h2 id="维护Cookie和周期"><a href="#维护Cookie和周期" class="headerlink" title="维护Cookie和周期"></a>维护Cookie和周期</h2><p>修改对应的值，需要保持其他的值不变才能修改成功。不然就等于新增了一个cookie。</p>
<h3 id="自动删除"><a href="#自动删除" class="headerlink" title="自动删除"></a>自动删除</h3><p>以下三个原因导致cookie被浏览器自动删除：</p>
<ul>
<li>会话结束自动删除</li>
<li>expires到期自动删除</li>
<li>超过上线自动删除相对较旧的cookie</li>
</ul>
<h2 id="其他限制"><a href="#其他限制" class="headerlink" title="其他限制"></a>其他限制</h2><ul>
<li>HTTP-Only: 这个将使浏览器无法使用JavaScript访问该cookie。</li>
</ul>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.nczonline.net/blog/2009/05/05/http-cookies-explained/">HTTP cookies explained</a></li>
<li><a target="_blank" rel="noopener" href="https://www.nczonline.net/blog/2009/05/12/cookies-and-security/">Cookies and security</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie/Simple_document.cookie_framework">Simple cookie framework</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-10-27T10:37:14.000Z" title="10/27/2017, 6:37:14 PM">2017-10-27</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:00:02.000Z" title="5/23/2020, 2:00:02 PM">2020-05-23</time></span><span class="level-item">3 minutes read (About 426 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/27/about-deploly-favweb-3/">从零开始，部署一个Web应用（三）Vue.js &amp; Redis</a></h1><div class="content"><p>这篇文章，就总结一些<code>Vue.js</code>和<code>Redis</code>遇到的问题。</p>
<h1 id="Vue-js"><a href="#Vue-js" class="headerlink" title="Vue.js"></a>Vue.js</h1><h2 id="非index页面刷新报404"><a href="#非index页面刷新报404" class="headerlink" title="非index页面刷新报404"></a>非index页面刷新报404</h2><p>由于采用了<code>Vue-router</code>前端路由。因此在非index页面刷新会出现404的问题。</p>
<p>原理：Vue.js是单页面应用(SPA)，除了主页，其他页面都是利用hash或者HTML5 History API实现的，是浏览器虚拟的路由，故需要配置一下服务器。</p>
<p>以下是nginx的解决方案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name favweb.cn;</span><br><span class="line">    access_log  off;</span><br><span class="line"></span><br><span class="line">    root /home/vuejs/dist;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">      try_files $uri $uri/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="页面统计问题"><a href="#页面统计问题" class="headerlink" title="页面统计问题"></a>页面统计问题</h2><p>由于Google Analytics的不可用，采用的是百度统计。</p>
<p>发现统计数据都是只有主页，因此又是因为SPA的问题。</p>
<p>解决方案是在前端路由切换的时候，手动调用PV追踪代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_hmt.push([<span class="string">&#x27;_trackPageview&#x27;</span>, pageURL]);</span><br></pre></td></tr></table></figure>

<p>Vuejs的配置为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router(config)</span><br><span class="line"></span><br><span class="line">router.afterEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>._hmt.push([<span class="string">&#x27;_trackPageview&#x27;</span>, to.path])</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123; &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-4.0.2.tar.gz</span><br><span class="line">tar xzf redis-4.0.2.tar.gz</span><br><span class="line">cd redis-4.0.2</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<h2 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h2><p>以<code>MacOS</code>的<code>homebrew</code>安装方式为例。其中<code>redis.conf</code>文件在<code>/usr/local/etc/</code>。</p>
<h3 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 原来</span><br><span class="line">daemonize no</span><br><span class="line"></span><br><span class="line"># 改成</span><br><span class="line">daemonize yes</span><br></pre></td></tr></table></figure>

<h3 id="增加密码"><a href="#增加密码" class="headerlink" title="增加密码"></a>增加密码</h3><p>找到<code>requirepass</code>，去掉前面的注释符号<code>#</code>，后面改成自己的密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#原来</span><br><span class="line">#requirepass yourPassword</span><br><span class="line"></span><br><span class="line">#改成</span><br><span class="line">requirepass yourPassword</span><br></pre></td></tr></table></figure>

<h3 id="远程访问"><a href="#远程访问" class="headerlink" title="远程访问"></a>远程访问</h3><p>找到<code>bind</code>，将<code>127.0.0.1</code>改成<code>0.0.0.0</code>即可。</p>
<p>因为安全问题，默认只绑定在127.0.0.1，这样的话就只有运行redis的那台机器可以访问，其他机器都无法访问。</p>
<p>因此要开启这个之前，一定要先设置好密码。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-10-21T13:37:14.000Z" title="10/21/2017, 9:37:14 PM">2017-10-21</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T05:59:59.000Z" title="5/23/2020, 1:59:59 PM">2020-05-23</time></span><span class="level-item">5 minutes read (About 735 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/21/about-deploly-favweb-2/">从零开始，部署一个Web应用（二）MongoDB &amp; nginx</a></h1><div class="content"><p>这篇文章，就总结一些部署<code>MongoDB</code>和<code>nginx</code>遇到的问题。</p>
<h1 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h1><p>安装的是社区版本(<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/">MongoDB Community Edition</a>)。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>先创建Mongodb在yum的配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mongodb-org-3.4]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可动态改变版本号</p>
</blockquote>
<p>然后使用<code>yum</code>安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y mongodb-org</span><br></pre></td></tr></table></figure>

<h2 id="安全相关"><a href="#安全相关" class="headerlink" title="安全相关"></a>安全相关</h2><p>如果是仅仅是本地开发，完全可以忽略这一步。但是如果要放到线上，就一定要增加安全验证。</p>
<p>在MongoDB中，常用的是增加<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/tutorial/enable-authentication/">用户访问限制</a>。</p>
<h3 id="高级管理员"><a href="#高级管理员" class="headerlink" title="高级管理员"></a>高级管理员</h3><p>第一步，是先创建一个高级管理员。这个高级管理员可<strong>管理其他用户</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; use admin</span><br><span class="line">&gt; db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: &quot;myUserAdmin&quot;,</span><br><span class="line">    pwd: &quot;abc123&quot;,</span><br><span class="line">    roles: [ &#123; role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意，admin用户是无法访问其他数据库的，访问其他数据库需要增加新用户。</p>
</blockquote>
<p>可以这样以该角色进入MongoDB的命令行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27017 -u &quot;myUserAdmin&quot; -p &quot;abc123&quot; --authenticationDatabase &quot;admin&quot;</span><br></pre></td></tr></table></figure>

<h3 id="增加其他用户"><a href="#增加其他用户" class="headerlink" title="增加其他用户"></a>增加其他用户</h3><p>MongoDB的用户权限是和数据库绑定的，故创建用户前需进入一个指定数据库，比如进入<code>test</code>数据库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use test</span><br></pre></td></tr></table></figure>

<p>然后创建角色时，设置账户，密码以及对应的数据库权限，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: &quot;testAdmin&quot;,</span><br><span class="line">    pwd: &quot;abc123&quot;,</span><br><span class="line">    roles: [ &#123; role: &quot;readWrite&quot;, db: &quot;test&quot; &#125;,</span><br><span class="line">             &#123; role: &quot;read&quot;, db: &quot;reporting&quot; &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h1 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h1><p>安装nginx之前，需要先将nginx的依赖安装完：</p>
<ul>
<li>gcc 安装：<code>yum install gcc-c++</code></li>
<li>PCRE pcre-devel 安装：<code>yum install -y pcre pcre-devel</code></li>
<li>zlib 安装: <code>yum install -y zlib zlib-devel</code></li>
<li>OpenSSL 安装: <code>yum install -y openssl openssl-devel</code></li>
</ul>
<h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 下载Nginx</span><br><span class="line">wget -c https://nginx.org/download/nginx-1.10.1.tar.gz</span><br><span class="line"></span><br><span class="line"># 解压：</span><br><span class="line">tar -zxvf nginx-1.10.1.tar.gz</span><br><span class="line"></span><br><span class="line"># 进入nginx解压目录</span><br><span class="line">cd nginx-1.10.1 </span><br><span class="line"></span><br><span class="line"># 配置：</span><br><span class="line">./configure</span><br><span class="line"></span><br><span class="line"># 编译安装:</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"># 查找安装路径：</span><br><span class="line">whereis nginx</span><br></pre></td></tr></table></figure>

<h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><p>因为是二进制安装，所以环境变量需要手动设置，即此时不能直接使用<code>nginx</code>命令。</p>
<p>设置环境变量的方法是：将nginx的二进制文件复制的系统bin目录下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/nginx/sbin/nginx /usr/local/bin</span><br></pre></td></tr></table></figure>

<blockquote>
<p>假设上面的whereis nginx返回的是/usr/local/nginx</p>
</blockquote>
<h2 id="开启SSL模块"><a href="#开启SSL模块" class="headerlink" title="开启SSL模块"></a>开启SSL模块</h2><p>切换到安装的源码包，我是安装在<code>/usr/local/src/nginx-1.11.3</code>。</p>
<p>修改配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx --with-http_ssl_modul</span><br></pre></td></tr></table></figure>

<p>执行<code>make</code>之后，切记<strong>不要执行</strong><code>make install</code>，否则就覆盖安装了。</p>
<p>先备份已安装好的nginx:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak</span><br></pre></td></tr></table></figure>

<p>然后关闭已启动的nginx：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 查看进程号</span><br><span class="line">ps -ef|grep nginx</span><br><span class="line">kill -QUIT [进程号]</span><br></pre></td></tr></table></figure>

<p>将刚刚编译好的nginx覆盖掉原有的nginx:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>

<p>启动nginx，仍可以通过命令查看是否已经加入成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -V　</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-10-14T12:37:14.000Z" title="10/14/2017, 8:37:14 PM">2017-10-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T05:59:55.000Z" title="5/23/2020, 1:59:55 PM">2020-05-23</time></span><span class="level-item">2 minutes read (About 368 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/14/about-deploly-favweb-1/">从零开始，部署一个Web应用（一）</a></h1><div class="content"><p>起始篇，先介绍一个整个系列文章涉及到的开发环境，技术盏。</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>开发环境：</p>
<p>设备：MacBook Pro 2015<br>环境：Node.js v8.9.3 + WebPack v3.0<br>IDE：Sublime Text + Visual Studio Code</p>
<p>生产环境：</p>
<p>设备：腾讯云CVM(香港)<br>系统：CentOS 7.2 64位</p>
<h2 id="技术盏"><a href="#技术盏" class="headerlink" title="技术盏"></a>技术盏</h2><p>前端采用了Vue.js + Vue-router + Element-UI</p>
<blockquote>
<p>采用Vue.js是因为最近都在使用Vue.js技术盏，但是从未从零开始创建一个Vue.js项目。故想尝试一遍。</p>
</blockquote>
<blockquote>
<p>而采用Elment-UI是因为不想花太多事件在UI的设计上，毕竟我的设计能力有限。</p>
</blockquote>
<p>后端采用 Node.js + Think.js</p>
<blockquote>
<p>因为个人技术盏限制，故采用比较擅长的Node.js。</p>
</blockquote>
<blockquote>
<p>采用Think.js是因为目前所在公司是这个方案，也觉得这样比较省事，不想Express那样灵活，什么都需要自己配置。</p>
</blockquote>
<p>数据库采用MongoDB + Redis</p>
<blockquote>
<p>MongoDB是No SQL数据库，和JavaScipt的JSON格式完美匹配，为了高效开发而选。另外，数据结构的不确定性也是一个因素。</p>
</blockquote>
<blockquote>
<p>Redis是用来保存Session，邀请码等数据。</p>
</blockquote>
<p>服务器部署：Nginx + Node.js反向代理</p>
<blockquote>
<p>利用Nginx来实现负载均衡</p>
</blockquote>
<p>代码管理：<a target="_blank" rel="noopener" href="https://coding.net/">Coding</a></p>
<blockquote>
<p>由于GitHub的私有仓库需要收费，所以选了一个国内的代码仓库。</p>
</blockquote>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-10-06T09:14:44.000Z" title="10/6/2017, 5:14:44 PM">2017-10-06</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:05:36.000Z" title="5/23/2020, 2:05:36 PM">2020-05-23</time></span><span class="level-item">10 minutes read (About 1484 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/06/how-to-use-buffers/">如果使用Node.js的Buffers</a></h1><div class="content"><h1 id="为什么要有Buffers？"><a href="#为什么要有Buffers？" class="headerlink" title="为什么要有Buffers？"></a>为什么要有Buffers？</h1><p>在纯<code>JavaScript</code>开发中，unicode编码的字符串也够好用的了，并不需要直接处理二进制数据(straight binary data)。在浏览器环境，大部分数据都是字符串的形式，这是足够的。然而，Node.js是服务器环境，必须要处理TCP流还有文件系统的读取和写入流，这就让<code>JavaScript</code>需要处理纯二进制数据了。</p>
<p>其实，要解决这个问题直接使用字符串也是可以的，这也是Node.js一开始的做法。然而，这样的做法有许多问题，也很慢。</p>
<p>所以，记住了，别使用二进制字符串(binary strings)，用<strong>buffers</strong>代替它！</p>
<h1 id="什么是Buffers？"><a href="#什么是Buffers？" class="headerlink" title="什么是Buffers？"></a>什么是Buffers？</h1><p>在Node.js里，Buffers是专门设计来处理原始二进制数据的，是Buffer这个类的实例。</p>
<p>每个buffer在V8引擎外都有内存分配。Buffer操作起来和包含数字的数组一样，但是不像数组那样自由设置大小的。并且buffer拥有一系列操作二进制数据的方法。</p>
<blockquote>
<p>另外，buffer里的“数字”代表的是byte并且限制大小是0到255(2^8-1)</p>
</blockquote>
<h1 id="在哪里可以看到buffers"><a href="#在哪里可以看到buffers" class="headerlink" title="在哪里可以看到buffers"></a>在哪里可以看到buffers</h1><p>一般情况，buffer经常可以在读取二进制数据流的时候看到，比如<code>fs.createReadStream</code></p>
<h2 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h2><h3 id="创建buffer"><a href="#创建buffer" class="headerlink" title="创建buffer"></a>创建buffer</h3><p>有许多方法可以生成新的buffers：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> Buffer(<span class="number">8</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个buffer是未初始化的，且包含8个字节(bytes)。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var buffer = new Buffer([ 8, 6, 7, 5, 3, 0, 9]);</span><br></pre></td></tr></table></figure>

<p>这个buffer用一个数组的内容来初始化。记住了，<strong>数组里的数字表示的是字节(bytes)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var buffer = new Buffer(&quot;I&#x27;m a string!&quot;, &quot;utf-8&quot;)</span><br></pre></td></tr></table></figure>

<p>通过第二个参数来指定编码(默认是utf-8)的字符串来初始化buffer。utf-8是在Node.js里最常用的编码，但是buffer还支持其他编码：</p>
<ul>
<li>“ascii”：这个编码方式很快，但是只限制ascii字符集。而且这个编码会将null转换成空格，而不像utf-8编码。</li>
<li>“ucs2”：一种双字节，小端存储的编码。可以编码一个unicode的子集。</li>
<li>“base64”：Base64字符串编码。</li>
<li>“binary”：这个“二进制字符串”前面提到过，这个编码即将被弃用，避免使用这个。</li>
</ul>
<h3 id="写入buffer"><a href="#写入buffer" class="headerlink" title="写入buffer"></a>写入buffer</h3><h4 id="创建一个buffer："><a href="#创建一个buffer：" class="headerlink" title="创建一个buffer："></a>创建一个buffer：</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> buffer = <span class="keyword">new</span> Buffer(<span class="number">16</span>);</span><br></pre></td></tr></table></figure>

<p>开始写入字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; buffer.write(&quot;Hello&quot;, &quot;utf-8&quot;)</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<p><code>buffer.write</code>的第一个参数是写入buffer的字符串，而第二个参数是这个字符串的编码方式。如果字符串的编码是utf-8，那么这个参数是多余的。</p>
<p><code>buffer.write</code>返回5，这代表我们写入了5个字节到这个buffer。事实上，“Hello“这个字符串也刚好是5个字符。这是因为刚好每个字符都是8位(bits)。这对补全字符串很重要：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; buffer.write(<span class="string">&quot; world!&quot;</span>, <span class="number">5</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="number">7</span></span><br></pre></td></tr></table></figure>

<p>当<code>buffer.write</code>有3个参数的时候，第二个参数代表是偏移量，或者说是buffer开始写入的位置。</p>
<h3 id="读取buffer"><a href="#读取buffer" class="headerlink" title="读取buffer"></a>读取buffer</h3><h4 id="toString："><a href="#toString：" class="headerlink" title="toString："></a>toString：</h4><p>这个方法可能是读取buffer最通用的方法了，因为很多buffer都包含文本：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; buffer.toString(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;Hello world!\u0000�k\t&#x27;</span></span><br></pre></td></tr></table></figure>

<p>再一次，第一个参数代表编码方式。这里可以看到并没有用完整个buffer。幸运的是，我们知道写入了多少字节到这个buffer，我们可以简单地增加参数去割开这个字符串：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; buffer.toString(<span class="string">&quot;utf-8&quot;</span>, <span class="number">0</span>, <span class="number">12</span>)</span><br><span class="line"><span class="string">&#x27;Hello world!&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="独立字节："><a href="#独立字节：" class="headerlink" title="独立字节："></a>独立字节：</h4><p>你可以看到用类似数组的语法来设置独立位(individual bits)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; buffer[<span class="number">12</span>] = buffer[<span class="number">11</span>];</span><br><span class="line"><span class="number">33</span></span><br><span class="line">&gt; buffer[<span class="number">13</span>] = <span class="string">&quot;1&quot;</span>.charCodeAt();</span><br><span class="line"><span class="number">49</span></span><br><span class="line">&gt; buffer[<span class="number">14</span>] = buffer[<span class="number">13</span>];</span><br><span class="line"><span class="number">49</span></span><br><span class="line">&gt; buffer[<span class="number">15</span>] = <span class="number">33</span></span><br><span class="line"><span class="number">33</span></span><br><span class="line">&gt; buffer.toString(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="string">&#x27;Hello world!!11!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在这个例子里，手动地设置剩余的字节，这样就代表了“utf-8”编码的“！”和“1“字符了。</p>
<h2 id="更多有趣用法"><a href="#更多有趣用法" class="headerlink" title="更多有趣用法"></a>更多有趣用法</h2><h3 id="Buffer-isBuffer-object"><a href="#Buffer-isBuffer-object" class="headerlink" title="Buffer.isBuffer(object)"></a>Buffer.isBuffer(object)</h3><p>这个方法是检测一个对象是否是buffer，类似于<code>Array.isArray</code></p>
<h3 id="Buffer-byteLength-string-encoding"><a href="#Buffer-byteLength-string-encoding" class="headerlink" title="Buffer.byteLength(string, encoding)"></a>Buffer.byteLength(string, encoding)</h3><p>通过这个方法，你可以获取字符串(默认utf-8编码)的字节数。这个长度和字符串的长度(string length)不一样，因为很多字符需要更多的字节，例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> snowman = <span class="string">&quot;☃&quot;</span>;</span><br><span class="line">&gt; snowman.length</span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; Buffer.byteLength(snowman)</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>这个unicode的雪人只有两个字符，却占了3个字节。</p>
<h3 id="buffer-length"><a href="#buffer-length" class="headerlink" title="buffer.length"></a>buffer.length</h3><p>这个是buffer的长度，也代表分配了多少内存。这个不等于buffer内容的大小，因为buffer有可能是没满的，比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> buffer = <span class="keyword">new</span> Buffer(<span class="number">16</span>)</span><br><span class="line">&gt; buffer.write(snowman)</span><br><span class="line"><span class="number">3</span></span><br><span class="line">&gt; buffer.length</span><br><span class="line"><span class="number">16</span></span><br></pre></td></tr></table></figure>

<p>在这个例子里，我们只写入了3个字符，但是长度依然是16，因为这是已经初始化了的。</p>
<h3 id="buffer-copy-target-targetStart-0-sourceStart-0-sourceEnd-buffer-length"><a href="#buffer-copy-target-targetStart-0-sourceStart-0-sourceEnd-buffer-length" class="headerlink" title="buffer.copy(target, targetStart=0, sourceStart=0, sourceEnd=buffer.length)"></a>buffer.copy(target, targetStart=0, sourceStart=0, sourceEnd=buffer.length)</h3><p><code>buffer.copy</code>允许拷贝一个buffer的内容到另一个buffer。</p>
<p>第一个参数表示<strong>目标buffer</strong>，就是要写入内容的buffer。</p>
<p>另外一个参数是指定需要拷贝到目标buffer的开始位置。看个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> frosty = <span class="keyword">new</span> Buffer(<span class="number">24</span>)</span><br><span class="line">&gt; <span class="keyword">var</span> snowman = <span class="keyword">new</span> Buffer(<span class="string">&quot;☃&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">&gt; frosty.write(<span class="string">&quot;Happy birthday! &quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="number">16</span></span><br><span class="line">&gt; snowman.copy(frosty, <span class="number">16</span>)</span><br><span class="line"><span class="number">3</span></span><br><span class="line">&gt; frosty.toString(<span class="string">&quot;utf-8&quot;</span>, <span class="number">0</span>, <span class="number">19</span>)</span><br><span class="line"><span class="string">&#x27;Happy birthday! ☃&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在这个例子，拷贝了含有3个字节长度的“snowman”buffer到“forsty”buffer。</p>
<p>其中forsty一开始写入了前16个字节，而snowman有3个字节长，因此结果就是19个字节长。</p>
<h3 id="buffer-slice-start-end-buffer-length"><a href="#buffer-slice-start-end-buffer-length" class="headerlink" title="buffer.slice(start, end=buffer.length)"></a>buffer.slice(start, end=buffer.length)</h3><p>这个方法的API可以说和<code>Array.prototype.slice</code>是一样的。</p>
<p>不过其中一个特别重要的区别是：这个slice方法不是简单地返回一个新的buffer，也不仅仅是内存中子集的引用。这个slice会改变原来的buffer！举例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> puddle = frosty.slice(<span class="number">16</span>, <span class="number">19</span>)</span><br><span class="line">&gt; puddle.toString()</span><br><span class="line"><span class="string">&#x27;☃&#x27;</span></span><br><span class="line">&gt; puddle.write(<span class="string">&quot;___&quot;</span>)</span><br><span class="line"><span class="number">3</span></span><br><span class="line">&gt; frosty.toString(<span class="string">&quot;utf-8&quot;</span>, <span class="number">0</span>, <span class="number">19</span>)</span><br><span class="line"><span class="string">&#x27;Happy birthday! ___&#x27;</span></span><br></pre></td></tr></table></figure>

<p>完。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-09-23T10:43:11.000Z" title="9/23/2017, 6:43:11 PM">2017-09-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:09:34.000Z" title="5/23/2020, 2:09:34 PM">2020-05-23</time></span><span class="level-item">9 minutes read (About 1405 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/09/23/underscore-featured-function/">理解underscore.js系列——④精选函数</a></h1><div class="content"><p>这篇文章就分析一些我觉得很常用，也很有趣的一些函数。很早以前就听过<code>underscore</code>的大名，但是很少去用到。通过这次阅读源码，发来了不少有趣的函数，也学习到了许多技巧，真实收益匪浅。</p>
<h3 id="sample"><a href="#sample" class="headerlink" title="_.sample"></a>_.sample</h3><p>随意取出数组中的N个元素。</p>
<p>按我的思路，就是使用<code>_.random</code>得到索引然后取N个元素，但是这个方法有一个问题，就是有可能取到同个元素。</p>
<p><code>underscore</code>则另辟蹊径，其算法是遍历前N个元素，每个元素和任意位置的元素替换，最后返回前N个元素即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sample **n** random values from a collection using the modern version of the</span></span><br><span class="line"><span class="comment">// [Fisher-Yates shuffle](http://en.wikipedia.org/wiki/Fisher–Yates_shuffle).</span></span><br><span class="line"><span class="comment">// If **n** is not specified, returns a single random element.</span></span><br><span class="line"><span class="comment">// The internal `guard` argument allows it to work with `map`.</span></span><br><span class="line">_.sample = <span class="function"><span class="keyword">function</span>(<span class="params">obj, n, guard</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (n == <span class="literal">null</span> || guard) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isArrayLike(obj)) obj = _.values(obj);</span><br><span class="line">    <span class="keyword">return</span> obj[_.random(obj.length - <span class="number">1</span>)];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> sample = isArrayLike(obj) ? _.clone(obj) : _.values(obj);</span><br><span class="line">  <span class="keyword">var</span> length = getLength(sample);</span><br><span class="line">  n = <span class="built_in">Math</span>.max(<span class="built_in">Math</span>.min(n, length), <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">var</span> last = length - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; n; index++) &#123;</span><br><span class="line">    <span class="keyword">var</span> rand = _.random(index, last);</span><br><span class="line">    <span class="keyword">var</span> temp = sample[index];</span><br><span class="line">    sample[index] = sample[rand];</span><br><span class="line">    sample[rand] = temp;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sample.slice(<span class="number">0</span>, n);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="throttle"><a href="#throttle" class="headerlink" title="_.throttle"></a>_.throttle</h3><p>节流函数，频繁触发的函数可用<code>throttle</code>来实现一段时间(周期取决于<code>wait</code>)内只执行一次。</p>
<p>常见的场景是：页面滚动时<code>scroll</code>、页面大小改变时<code>resize</code></p>
<p>可以看到，这个<code>throttle</code>函数是比较健壮的。</p>
<p>有<code>leading</code>、<code>trailing</code>可选，意思为开始和结束这个临界点是否触发。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Returns a function, that, when invoked, will only be triggered at most once</span></span><br><span class="line"><span class="comment">// during a given window of time. Normally, the throttled function will run</span></span><br><span class="line"><span class="comment">// as much as it can, without ever going more than once per `wait` duration;</span></span><br><span class="line"><span class="comment">// but if you&#x27;d like to disable the execution on the leading edge, pass</span></span><br><span class="line"><span class="comment">// `&#123;leading: false&#125;`. To disable execution on the trailing edge, ditto.</span></span><br><span class="line">_.throttle = <span class="function"><span class="keyword">function</span>(<span class="params">func, wait, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> timeout, context, args, result;</span><br><span class="line">  <span class="keyword">var</span> previous = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (!options) options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> later = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    previous = options.leading === <span class="literal">false</span> ? <span class="number">0</span> : _.now();</span><br><span class="line">    timeout = <span class="literal">null</span>;</span><br><span class="line">    result = func.apply(context, args);</span><br><span class="line">    <span class="keyword">if</span> (!timeout) context = args = <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> throttled = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> now = _.now();</span><br><span class="line">    <span class="keyword">if</span> (!previous &amp;&amp; options.leading === <span class="literal">false</span>) previous = now;</span><br><span class="line">    <span class="keyword">var</span> remaining = wait - (now - previous);</span><br><span class="line">    context = <span class="built_in">this</span>;</span><br><span class="line">    args = <span class="built_in">arguments</span>;</span><br><span class="line">    <span class="keyword">if</span> (remaining &lt;= <span class="number">0</span> || remaining &gt; wait) &#123;</span><br><span class="line">      <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">        <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">        timeout = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      previous = now;</span><br><span class="line">      result = func.apply(context, args);</span><br><span class="line">      <span class="keyword">if</span> (!timeout) context = args = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!timeout &amp;&amp; options.trailing !== <span class="literal">false</span>) &#123;</span><br><span class="line">      timeout = <span class="built_in">setTimeout</span>(later, remaining);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  throttled.cancel = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">    previous = <span class="number">0</span>;</span><br><span class="line">    timeout = context = args = <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> throttled;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>实现<code>options.leading</code>（即开始时是否执行）相关：</p>
<ul>
<li>设置<code>var previous = 0;</code></li>
<li>默认不设置<code>options.leading</code>即默认开始时执行，故此时<code>if (!previous &amp;&amp; options.leading === false) previous = now;</code>不会执行。</li>
<li>此时，<code>previous = 0</code>。因此，<code>remaining = wait - (now - previous);</code>肯定小于0，故开始时必会执行。</li>
</ul>
<p>实现<code>options.trailing</code>（即最后是否执行一次）相关：</p>
<ul>
<li>考虑一个情况，只触发一次时，那么最终要在<code>wait</code>时间之后是否执行呢？</li>
<li>此时<code>underscore</code>就是使用一个定时器来实现。</li>
</ul>
<h3 id="debounce"><a href="#debounce" class="headerlink" title="_.debounce"></a>_.debounce</h3><p>防抖动函数。频繁执行一个函数时，只有停止执行之后的若干时间(取决于<code>wait</code>)才执行一次。</p>
<p>常见场景：输入框搜索的时候，停止输入n秒才发起搜索请求。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Returns a function, that, as long as it continues to be invoked, will not</span></span><br><span class="line"><span class="comment">// be triggered. The function will be called after it stops being called for</span></span><br><span class="line"><span class="comment">// N milliseconds. If `immediate` is passed, trigger the function on the</span></span><br><span class="line"><span class="comment">// leading edge, instead of the trailing.</span></span><br><span class="line">_.debounce = <span class="function"><span class="keyword">function</span>(<span class="params">func, wait, immediate</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> timeout, result;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> later = <span class="function"><span class="keyword">function</span>(<span class="params">context, args</span>) </span>&#123;</span><br><span class="line">    timeout = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (args) result = func.apply(context, args);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> debounced = restArgs(<span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (timeout) <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">    <span class="keyword">if</span> (immediate) &#123;</span><br><span class="line">      <span class="keyword">var</span> callNow = !timeout;</span><br><span class="line">      timeout = <span class="built_in">setTimeout</span>(later, wait);</span><br><span class="line">      <span class="keyword">if</span> (callNow) result = func.apply(<span class="built_in">this</span>, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      timeout = _.delay(later, wait, <span class="built_in">this</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  debounced.cancel = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">    timeout = <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> debounced;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到，该版本的<code>debounce</code>函数增加了<code>immediate</code>选项：就是刚开始的时候执行一次，n秒之后再执行一次。</p>
<p>在看<code>underscore</code>官网上，介绍说这个在防止意外的双击<code>submit</code>按钮时很有用。</p>
<p>这我有一点困惑，那不就提交了两次表单吗？</p>
<p>后来我发现，<code>later</code>函数里，执行<code>func</code>有一个前置条件:<code>if (args)</code>，而在<code>immediate = true</code>的情况下，<code>later</code>是这么调用的：<code>setTimeout(later, wait)</code>，这时没有传入任何参数，故<code>args = undefind</code>即<code>func</code>不会执行。</p>
<p>因此，<code>immediate = true</code>时，就只提交了一次表单，没任何问题。</p>
<h3 id="compose"><a href="#compose" class="headerlink" title="_.compose"></a>_.compose</h3><p>组成函数，类似<code>jQuery</code>的链式调用：将前一个函数的执行结果传入后一个函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Returns a function that is the composition of a list of functions, each</span></span><br><span class="line"><span class="comment">// consuming the return value of the function that follows.</span></span><br><span class="line">_.compose = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> args = <span class="built_in">arguments</span>;</span><br><span class="line">  <span class="keyword">var</span> start = args.length - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i = start;</span><br><span class="line">    <span class="keyword">var</span> result = args[start].apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">while</span> (i--) result = args[i].call(<span class="built_in">this</span>, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里我觉得<code>var i = start</code>似乎有些多余，但是如果站在代码语义(可读性的考虑)的角度的话，好像又不应该删除。</p>
<h3 id="after"><a href="#after" class="headerlink" title="_.after"></a>_.after</h3><p>执行N次之后才执行一次。这个方法的实现很简单，但是给我展示了一种新的开发模式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Returns a function that will only be executed on and after the Nth call.</span></span><br><span class="line">  _.after = <span class="function"><span class="keyword">function</span>(<span class="params">times, func</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (--times &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> func.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>javaScript</code>开发中，经常遇到异步调用的问题。</p>
<p>拿开发小程序为例，上传图片的功能官方只提供<code>单张上传API</code>，当我们要批量上次的时候，执行循环调用<code>单张上传API</code>。此时要全部上传完执行回调就可以使用这个方法了。</p>
<p>现在想想，我之前的做法是<code>setTimeout(uploadSuccess, 100)</code>，每隔0.1s去判断一下是否全部上传完毕，真是惭愧不如啊。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-09-18T06:52:42.000Z" title="9/18/2017, 2:52:42 PM">2017-09-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:09:22.000Z" title="5/23/2020, 2:09:22 PM">2020-05-23</time></span><span class="level-item">7 minutes read (About 1026 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/09/18/underscore-base-function/">理解underscore.js系列——③基础函数</a></h1><div class="content"><p>从<code>_.each</code>函数入手，理解<code>underscore.js</code>的基础函数，<code>_.each</code>的调用盏可以参考如下思维导图：</p>
<p><img src="http://7xnh42.com1.z0.glb.clouddn.com/each.jpg" alt="image"></p>
<p><code>underscore.js</code>的很多方法都是基于函数的，因此对于用户传入的回调函数都是需要处理的，<code>_.each</code>也不例外。因此先来介绍内置的<code>cb</code>函数还有<code>optimizeCb</code>函数</p>
<h3 id="cb"><a href="#cb" class="headerlink" title="cb"></a>cb</h3><p><code>cb</code>顾名思义，就是回调函数(CallBack的简称)的意思。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// An internal function to generate callbacks that can be applied to each</span></span><br><span class="line"><span class="comment">// element in a collection, returning the desired result — either `identity`,</span></span><br><span class="line"><span class="comment">// an arbitrary callback, a property matcher, or a property accessor.</span></span><br><span class="line"><span class="keyword">var</span> cb = <span class="function"><span class="keyword">function</span>(<span class="params">value, context, argCount</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (_.iteratee !== builtinIteratee) <span class="keyword">return</span> _.iteratee(value, context); <span class="comment">// 1</span></span><br><span class="line">  <span class="keyword">if</span> (value == <span class="literal">null</span>) <span class="keyword">return</span> _.identity; <span class="comment">// 2</span></span><br><span class="line">  <span class="keyword">if</span> (_.isFunction(value)) <span class="keyword">return</span> optimizeCb(value, context, argCount); <span class="comment">// 3</span></span><br><span class="line">  <span class="keyword">if</span> (_.isObject(value) &amp;&amp; !_.isArray(value)) <span class="keyword">return</span> _.matcher(value); <span class="comment">// 4</span></span><br><span class="line">  <span class="keyword">return</span> _.property(value);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>对于迭代函数(iteratee)来说，我们是可以重写成自己的迭代函数的。因此如果我们重新了的话就直接调用我们重写的<code>_.iteratee</code></li>
<li>如果没有传入<code>value</code>，就使用<code>_.identity = function(value) &#123; return value; &#125;</code></li>
<li>如果传入了<code>function</code>，则使用<code>optimizeCb</code>格式化一下</li>
<li>如果传入了<code>object</code>，就是返回一个匹配函数，用于判断后续传入对象是否和该对象一致</li>
<li>否则就将传入的值当成一个属性，返回一个匹配该属性的函数</li>
</ol>
<h3 id="optimizeCb"><a href="#optimizeCb" class="headerlink" title="optimizeCb"></a>optimizeCb</h3><p>格式化传入的回调函数，以统一迭代函数，方便后续使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Internal function that returns an efficient (for current engines) version</span></span><br><span class="line"><span class="comment">// of the passed-in callback, to be repeatedly applied in other Underscore</span></span><br><span class="line"><span class="comment">// functions.</span></span><br><span class="line"><span class="keyword">var</span> optimizeCb = <span class="function"><span class="keyword">function</span>(<span class="params">func, context, argCount</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果没有执行上下文，就直接返回该函数</span></span><br><span class="line">  <span class="keyword">if</span> (context === <span class="keyword">void</span> <span class="number">0</span>) <span class="keyword">return</span> func;</span><br><span class="line">  <span class="keyword">switch</span> (argCount) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> func.call(context, value);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// The 2-parameter case has been omitted only because no current consumers</span></span><br><span class="line">    <span class="comment">// made use of it.</span></span><br><span class="line">    <span class="keyword">case</span> <span class="literal">null</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>: <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">value, index, collection</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> func.call(context, value, index, collection);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>: <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">accumulator, value, index, collection</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> func.call(context, accumulator, value, index, collection);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> func.apply(context, <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="collectNonEnumProps"><a href="#collectNonEnumProps" class="headerlink" title="collectNonEnumProps"></a>collectNonEnumProps</h3><p>在IE9以下版本，会有一个bug：如果重写了<code>原不可枚举的属性</code>，使用<code>for...in</code>是不会返回的。</p>
<p>相关信息可参考：<a target="_blank" rel="noopener" href="http://www.w3help.org/zh-cn/causes/SJ5003">W3Help SJ5003</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Keys in IE &lt; 9 that won&#x27;t be iterated by `for key in ...` and thus missed.</span></span><br><span class="line"><span class="keyword">var</span> hasEnumBug = !&#123;<span class="attr">toString</span>: <span class="literal">null</span>&#125;.propertyIsEnumerable(<span class="string">&#x27;toString&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> nonEnumerableProps = [<span class="string">&#x27;valueOf&#x27;</span>, <span class="string">&#x27;isPrototypeOf&#x27;</span>, <span class="string">&#x27;toString&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;propertyIsEnumerable&#x27;</span>, <span class="string">&#x27;hasOwnProperty&#x27;</span>, <span class="string">&#x27;toLocaleString&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> collectNonEnumProps = <span class="function"><span class="keyword">function</span>(<span class="params">obj, keys</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> nonEnumIdx = nonEnumerableProps.length;</span><br><span class="line">  <span class="comment">// 获取对象的构造函数，以获取对象的原型</span></span><br><span class="line">  <span class="keyword">var</span> <span class="title">constructor</span> = <span class="title">obj</span>.<span class="title">constructor</span>;</span><br><span class="line">  <span class="keyword">var</span> proto = _.isFunction(<span class="title">constructor</span>) &amp;&amp; <span class="title">constructor</span>.<span class="title">prototype</span> || <span class="title">ObjProto</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Constructor is a special case.</span></span><br><span class="line">  <span class="comment">// 将构造函数属性放入keys</span></span><br><span class="line">  <span class="keyword">var</span> prop = <span class="string">&#x27;constructor&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (_.has(obj, prop) &amp;&amp; !_.contains(keys, prop)) keys.push(prop);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nonEnumIdx--) &#123;</span><br><span class="line">    prop = nonEnumerableProps[nonEnumIdx];</span><br><span class="line">    <span class="comment">// 如果obj有这个属性</span></span><br><span class="line">    <span class="comment">// obj[prop] !== proto[prop] 说明重写了该属性</span></span><br><span class="line">    <span class="comment">// keys不包含该属性</span></span><br><span class="line">    <span class="keyword">if</span> (prop <span class="keyword">in</span> obj &amp;&amp; obj[prop] !== proto[prop] &amp;&amp; !_.contains(keys, prop)) &#123;</span><br><span class="line">      keys.push(prop);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里就涉及到JavaScript的对象相关知识，可以参考另一篇文章<a href="/">待续</a></p>
<h3 id="restArgs"><a href="#restArgs" class="headerlink" title="restArgs"></a>restArgs</h3><p><code>rest</code>是剩余的意思，顾名思义就是剩余参数，以方便灵活使用函数，灵活传入参数。这个是功能在ES6已经实现了，使用方式为：<code>function(value, ...rest)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Similar to ES6&#x27;s rest param (http://ariya.ofilabs.com/2013/03/es6-and-rest-parameter.html)</span></span><br><span class="line"><span class="comment">// This accumulates the arguments passed into an array, after a given index.</span></span><br><span class="line"><span class="keyword">var</span> restArgs = <span class="function"><span class="keyword">function</span>(<span class="params">func, startIndex</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// func.length可获取函数定义的参数个数</span></span><br><span class="line">  <span class="comment">// eg: function (a, b) &#123;&#125;  =&gt; 2</span></span><br><span class="line">  startIndex = startIndex == <span class="literal">null</span> ? func.length - <span class="number">1</span> : +startIndex;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> length = <span class="built_in">Math</span>.max(<span class="built_in">arguments</span>.length - startIndex, <span class="number">0</span>),</span><br><span class="line">        rest = <span class="built_in">Array</span>(length),</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 将定义的最后一个参数和超过定义的参数都放进rest数组</span></span><br><span class="line">    <span class="keyword">for</span> (; index &lt; length; index++) &#123;</span><br><span class="line">      rest[index] = <span class="built_in">arguments</span>[index + startIndex];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这部分逻辑和下部分是重叠的。因为这三种情况是常用的，就可避免执行下面的逻辑。</span></span><br><span class="line">    <span class="keyword">switch</span> (startIndex) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> func.call(<span class="built_in">this</span>, rest);</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> func.call(<span class="built_in">this</span>, <span class="built_in">arguments</span>[<span class="number">0</span>], rest);</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>: <span class="keyword">return</span> func.call(<span class="built_in">this</span>, <span class="built_in">arguments</span>[<span class="number">0</span>], <span class="built_in">arguments</span>[<span class="number">1</span>], rest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将超出的部分(指rest)放在args数组的最后一位</span></span><br><span class="line">    <span class="keyword">var</span> args = <span class="built_in">Array</span>(startIndex + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; startIndex; index++) &#123;</span><br><span class="line">      args[index] = <span class="built_in">arguments</span>[index];</span><br><span class="line">    &#125;</span><br><span class="line">    args[startIndex] = rest;</span><br><span class="line">    <span class="keyword">return</span> func.apply(<span class="built_in">this</span>, args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里涉及到两个知识点：</p>
<ul>
<li><code>function.length</code>指的是函数定义的参数个数</li>
<li><code>function.call</code>和<code>function.apply</code>的区别：<code>call</code>需逐个传入参数，而<code>apply</code>则将参数放进一个数组传入</li>
</ul>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">Previous</a></div><div class="pagination-next"><a href="/page/3/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li><li><a class="pagination-link" href="/page/5/">5</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://wx.qlogo.cn/mmhead/PiajxSqBRaEKzztxtaqGaVk8KzgrnxCBJkB6RD6rEqGOicBLVhnzxM7g/0" alt="leejimqiu"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">leejimqiu</p><p class="is-size-6 is-block">Senior Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">44</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">33</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/leejim" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/leejim"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weixin" href="https://developers.weixin.qq.com/community/personal/oCJUsw4DgF0046Dd6X7b5Lm-INBA"><i class="fab fa-weixin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://tdesign.tencent.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TDesign</span></span><span class="level-right"><span class="level-item tag">tdesign.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://tdesign.tencent.com/miniprogram" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TDesign Miniprogram</span></span><span class="level-right"><span class="level-item tag">tdesign.tencent.com</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-06T12:21:28.000Z">2022-01-06</time></p><p class="title"><a href="/2022/01/06/miniprogram-function-property/">小程序自定义组件的函数属性及事件触发</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-17T06:59:13.000Z">2021-01-17</time></p><p class="title"><a href="/2021/01/17/promise/">前端进阶 - Promise原理&amp;宏微任务</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-05-23T06:40:56.000Z">2020-05-23</time></p><p class="title"><a href="/2020/05/23/mini-program/update/">自动更新机制</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-05-23T06:40:41.000Z">2020-05-23</time></p><p class="title"><a href="/2020/05/23/mini-program/thinking-about-components/">组件封装的思考</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-05-23T06:40:26.000Z">2020-05-23</time></p><p class="title"><a href="/2020/05/23/mini-program/think-about-subscribe/">订阅消息的思考</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">January 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/11/"><span class="level-start"><span class="level-item">November 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">October 2017</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">September 2017</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">July 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/05/"><span class="level-start"><span class="level-item">May 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">March 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/02/"><span class="level-start"><span class="level-item">February 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/11/"><span class="level-start"><span class="level-item">November 2016</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/10/"><span class="level-start"><span class="level-item">October 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/09/"><span class="level-start"><span class="level-item">September 2016</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/08/"><span class="level-start"><span class="level-item">August 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/07/"><span class="level-start"><span class="level-item">July 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/05/"><span class="level-start"><span class="level-item">May 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/10/"><span class="level-start"><span class="level-item">October 2015</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/09/"><span class="level-start"><span class="level-item">September 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Array/"><span class="tag">Array</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BFC/"><span class="tag">BFC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Buffers/"><span class="tag">Buffers</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CSS/"><span class="tag">CSS</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ES6/"><span class="tag">ES6</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTML/"><span class="tag">HTML</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTTP/"><span class="tag">HTTP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/History-API/"><span class="tag">History API</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Node-js/"><span class="tag">Node.js</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Session/"><span class="tag">Session</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Storage/"><span class="tag">Storage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cookie/"><span class="tag">cookie</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gulp/"><span class="tag">gulp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/promise-%E5%AE%8F%E4%BB%BB%E5%8A%A1-%E5%BE%AE%E4%BB%BB%E5%8A%A1/"><span class="tag">promise 宏任务 微任务</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tdesign/"><span class="tag">tdesign</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/underscore-js/"><span class="tag">underscore.js</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vue-js/"><span class="tag">vue.js</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%8B%E4%BB%B6/"><span class="tag">事件</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"><span class="tag">内存管理</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0/"><span class="tag">函数</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0%E5%B1%9E%E6%80%A7/"><span class="tag">函数属性</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"><span class="tag">垃圾回收</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"><span class="tag">小程序</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B1%9E%E6%80%A7/"><span class="tag">属性</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/"><span class="tag">模块化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/"><span class="tag">盒模型</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/"><span class="tag">编码规范</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"><span class="tag">网络安全</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B7%AF%E7%94%B1/"><span class="tag">路由</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%AE%E7%9B%98/"><span class="tag">键盘</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AD%E5%8C%85/"><span class="tag">闭包</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Jim Home" height="28"></a><p class="is-size-7"><span>&copy; 2022 leejimqiu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/leejim"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>