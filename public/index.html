<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Jim Home</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="leejimqiu"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="leejimqiu"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="技术博客，前端开发，微信小程序，VSCode"><meta property="og:type" content="blog"><meta property="og:title" content="Jim Home"><meta property="og:url" content="http://africans.com/"><meta property="og:site_name" content="Jim Home"><meta property="og:description" content="技术博客，前端开发，微信小程序，VSCode"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://africans.com/img/og_image.png"><meta property="article:author" content="leejimqiu"><meta property="article:tag" content="leejimqiu,"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://africans.com"},"headline":"Jim Home","image":["http://africans.com/img/og_image.png"],"author":{"@type":"Person","name":"leejimqiu"},"publisher":{"@type":"Organization","name":"Jim Home","logo":{"@type":"ImageObject","url":"http://africans.com/img/logo.svg"}},"description":"技术博客，前端开发，微信小程序，VSCode"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?6638f74329d0f52c5cdafdadb58010af";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Jim Home" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/leejim"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-01-06T12:21:28.000Z" title="1/6/2022, 8:21:28 PM">2022-01-06</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-01-06T13:35:08.076Z" title="1/6/2022, 9:35:08 PM">2022-01-06</time></span><span class="level-item">6 minutes read (About 918 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/01/06/miniprogram-function-property/">小程序自定义组件的函数属性及事件触发</a></h1><div class="content"><blockquote>
<p>开发小程序组件库 TDesign 有感</p>
</blockquote>
<p>微信小程序，从基础库 <code>2.0.9</code> 开始，自定义组件的 <code>type: Object</code> 属性（properties）支持函数类型的值了，但仍不支持函数类型的属性，即：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dialog.js</span></span><br><span class="line">Component(&#123;</span><br><span class="line">  <span class="attr">properties</span>: &#123;</span><br><span class="line">    <span class="attr">confirmBtn</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="built_in">Object</span>, <span class="comment">// ok</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">cancelBtn</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="built_in">Function</span> <span class="comment">// wrong</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">observer</span>: &#123;</span><br><span class="line">    <span class="function"><span class="title">confirmBtn</span>(<span class="params">obj</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(obj.bindgetuserinfo) <span class="comment">// function</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这种能力，在实现 Dialog 组件的时候，非常有用。这样在 Dialog 组件的 <code>cancel</code> 和 <code>confirm</code> 按钮可以方便地支持 Button 的各种开放能力。</p>
<p>于是，就会想当然地这样实现：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;t-dialog&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;cancel-btn&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">size</span>=<span class="string">&quot;&#123;&#123;cancelBtn.size&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;&#123;&#123;cancelBtn.type&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">plain</span>=<span class="string">&quot;&#123;&#123;cancelBtn.plain&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">disabled</span>=<span class="string">&quot;&#123;&#123;cancelBtn.disabled&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">open-type</span>=<span class="string">&quot;&#123;&#123;cancelBtn.openType&#125;&#125;&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">bindgetuserinfo</span>=<span class="string">&quot;&#123;&#123;cancelBtn.bindgetuserinfo&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    取消</span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;confirm-btn&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">size</span>=<span class="string">&quot;&#123;&#123;confirmBtn.size&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">&quot;&#123;&#123;confirmBtn.type&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">plain</span>=<span class="string">&quot;&#123;&#123;confirmBtn.plain&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">disabled</span>=<span class="string">&quot;&#123;&#123;confirmBtn.disabled&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">open-type</span>=<span class="string">&quot;&#123;&#123;confirmBtn.openType&#125;&#125;&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">bindgetuserinfo</span>=<span class="string">&quot;&#123;&#123;confirmBtn.bindgetuserinfo&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    确认</span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样就会出现几个问题：</p>
<ul>
<li>属性透传写法太冗余</li>
<li>事件不会触发</li>
<li>按钮内容没法传入</li>
</ul>
<h2 id="属性透传"><a href="#属性透传" class="headerlink" title="属性透传"></a>属性透传</h2><p>Dialog 组件存在两个按钮，所以两个按钮都需要透传 button 属性，直观的想法就是采用 template 来处理:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- button.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;button&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;&#123;&#123;class&#125;&#125;&quot;</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">size</span>=<span class="string">&quot;&#123;&#123;size&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">type</span>=<span class="string">&quot;&#123;&#123;type&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">plain</span>=<span class="string">&quot;&#123;&#123;plain&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">disabled</span>=<span class="string">&quot;&#123;&#123;disabled&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">open-type</span>=<span class="string">&quot;&#123;&#123;openType&#125;&#125;&quot;</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">bindgetuserinfo</span>=<span class="string">&quot;&#123;&#123;bindgetuserinfo&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">    确认</span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>于是 Dialog 的代码就可以省略成这样：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">src</span>=<span class="string">&quot;./button.wxml&quot;</span> /&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;t-dialog&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">&quot;button&quot;</span> <span class="attr">data</span>=<span class="string">&#123;&#123;...cancelBtn,</span> <span class="attr">class:</span> &#x27;<span class="attr">cancel-btn</span>&#x27;&#125;&#125;&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">&quot;button&quot;</span> <span class="attr">data</span>=<span class="string">&#123;&#123;...confirmBtn,</span> <span class="attr">class:</span> &#x27;<span class="attr">confirm-btn</span>&#x27;&#125;&#125;&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里确实挺奇怪的，可以直接传入了一个解构后的值。</p>
<blockquote>
<p>这里可以直接合并对象</p>
</blockquote>
<h2 id="事件不会触发"><a href="#事件不会触发" class="headerlink" title="事件不会触发"></a>事件不会触发</h2><p>一开始以为是 template 的值传递过程，不支持 function 类型的值，因此丢失了。</p>
<p>比如在 template 里面使用 wxs 打印类型，居然是空的。</p>
<p>后来经过各种测试，最后在官网文档找到答案：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/event.html">小程序框架/事件系统</a></p>
<p>在小程序的事件绑定，只需要传入的是字符串: </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">bindtap</span>=<span class="string">&quot;handletap&quot;</span>&gt;</span>Tap me!<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也可以是一个数据绑定:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">bindtap</span>=<span class="string">&quot;&#123;&#123; handlerName &#125;&#125;&quot;</span>&gt;</span>Tap me!<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但，这个数据的返回值类型应该是 string 而不是 function。</p>
<p>通过这点，恍然大悟，想起了小程序的双线程模型：</p>
<p><img src="https://res.wx.qq.com/wxdoc/dist/assets/img/4-1.ad156d1c.png"></p>
<p>为了减轻线程之间的传输负担，是不需要将 function 传到渲染层的，只需要给一个函数名，然后在逻辑层执行对应的函数即可。</p>
<p>因此没有办法在 wxml 里面执行对象属性的函数，需要找一个代理函数（Proxy function）处理。</p>
<p>为了区分对应的按钮，因此 template 做了小改动，增加了一个 <code>data-token</code> 的属性：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;button&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">data-token</span>=<span class="string">&quot;&#123;&#123;token&#125;&#125;&quot;</span> <span class="attr">bindtap</span>=<span class="string">&quot;onTplButtonTap&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的 Dialog 的 wxml 的改动是这样的：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">src</span>=<span class="string">&quot;button.wxml&quot;</span> /&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;t-dialog&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">&quot;button&quot;</span> <span class="attr">data</span>=<span class="string">&#123;&#123;...cancelBtn,</span> <span class="attr">token:</span> &#x27;<span class="attr">cancel</span>&#x27;, <span class="attr">class:</span> &#x27;<span class="attr">cancel-btn</span>&#x27;&#125;&#125;&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">&quot;button&quot;</span> <span class="attr">data</span>=<span class="string">&#123;&#123;...confirmBtn,</span> <span class="attr">token:</span> &#x27;<span class="attr">confirm</span>&#x27;, <span class="attr">class:</span> &#x27;<span class="attr">confirm-btn</span>&#x27;&#125;&#125;&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的 JS 是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Component(&#123;</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="function"><span class="title">onTplButtonTap</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; token &#125; = e.target.dataset <span class="comment">// cancel or confirm</span></span><br><span class="line">      <span class="keyword">const</span> evtType = e.type <span class="comment">// 对应的事件名，如 getuserinfo/getphonenumber 等</span></span><br><span class="line">      <span class="keyword">const</span> evtName = <span class="string">`bind<span class="subst">$&#123;evtType&#125;</span>`</span></span><br><span class="line">      <span class="keyword">const</span> targetBtn = <span class="built_in">this</span>.data[<span class="string">`<span class="subst">$&#123;type&#125;</span>Btn`</span>]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> targetBtn[evtName] == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        targetBtn[evtName](e.detail)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这样就能完美透传并触发各种 button 事件了。</p>
<h2 id="按钮内容传入"><a href="#按钮内容传入" class="headerlink" title="按钮内容传入"></a>按钮内容传入</h2><p>其事这个倒是个小问题，因为 TDesign 组件在规划的时候，就已经充分地考虑了多框架之间的差异。为了弥补框架之间的差异，都可以通过 content 的属性来传入插槽的内容，起初我还不理解，直到遇到了这个问题。</p>
<p>以前总觉得，可以通过 slot 的方式传入，又支持一个 content 有点多此一举。直到我遇到了需要透传 button 属性的 dialog 组件。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>小程序的黑盒子运行时，在遇到问题的时候真的很容易陷入盲调的困境，此时应该去看看官方文档的资料，或者网上搜一下是否其他人也遇到类似的问题，这样才可能破局。</p>
<p>毕竟只有他们才知道代码是怎么跑的。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-01-17T06:59:13.000Z" title="1/17/2021, 2:59:13 PM">2021-01-17</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-01-20T14:27:50.000Z" title="1/20/2021, 10:27:50 PM">2021-01-20</time></span><span class="level-item">13 minutes read (About 1914 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/17/promise/">前端进阶 - Promise原理&amp;宏微任务</a></h1><div class="content"><hr>
<p>读完这篇文章，你的收获有：</p>
<ol>
<li>Promise简史</li>
<li>Promise的关键概念</li>
<li>可以手写符合标准的Promise</li>
<li>可以解答任意宏任务/微任务的题目</li>
</ol>
<h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>为什么写这篇文章？</p>
<p>JavaScript是异步语言，因此Promise的重要性不言而喻。</p>
<p>而我看了一些文章，觉得质量参差不齐。</p>
<p>于是就系统地整理了些资料，然后输出一篇文章，即帮助他人，也能让大家给我挑问题，避免自己错而不知。</p>
<p>由于能力有限，文中可能存在错误，望广大网友指正。</p>
<h1 id="1-Promise简史"><a href="#1-Promise简史" class="headerlink" title="1. Promise简史"></a>1. Promise简史</h1><p>Promise并不是一个新鲜的概念，早在2011年就出现在社区里了，目的是为了解决著名的回调地狱问题。</p>
<p>这个概念是在JQuery Deferred Objects出现之后，开始流行的。并于2012年，Promise被提出作为规范：<a target="_blank" rel="noopener" href="https://promisesaplus.com/">Promise/A+</a>。</p>
<p>在成为ES6标准之前，社区里也出现了许多符合Promise标准的库，如bluebird、q、when等等。</p>
<h1 id="2-Promise的关键概念"><a href="#2-Promise的关键概念" class="headerlink" title="2. Promise的关键概念"></a>2. Promise的关键概念</h1><blockquote>
<p>“The Promise object is used for deferred and asynchronous computations. A Promise represents an operation that hasn’t completed yet, but is expected in the future.” — MDN Promise Reference</p>
</blockquote>
<p>Promise的基础认知，推荐看阮一峰的<a target="_blank" rel="noopener" href="https://es6.ruanyifeng.com/#docs/promise">《ES6 入门教程》</a>。</p>
<p>本文的重点是讲解一些手写Promise需要关注的关键概念。</p>
<h2 id="2-1-Promise有三个状态："><a href="#2-1-Promise有三个状态：" class="headerlink" title="2.1 Promise有三个状态："></a>2.1 Promise有三个状态：</h2><ul>
<li>pending</li>
<li>resolved</li>
<li>rejected</li>
</ul>
<p>只能从pending到resolved或rejected，之后状态就凝固了。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0704fc368da4c8cb5acee94a1659a1b~tplv-k3u1fbpfcp-watermark.image"></p>
<p>当状态流转成resolved时，需要选择一个值作为当前Promise的value：</p>
<ul>
<li><code>new Promise</code>时，则是通过<code>resolve(val)</code></li>
<li><code>promise.then</code>时，则是通过<code>return</code>（需要注意的是，没有显式<code>return</code>时是默认<code>return undefined</code>）</li>
</ul>
<p>这个值可以是任意的合法JavaScript值（包括<code>undefined</code>、<code>thenable对象</code>或者<code>promise</code>）</p>
<blockquote>
<p>thenable对象是一个定义了then方法的对象或者函数</p>
</blockquote>
<p>状态流转成rejected时，则需要用一个reason来作为当前Promise被reject的理由，和resolved时同理。</p>
<h2 id="2-2-Promise-prototype-then"><a href="#2-2-Promise-prototype-then" class="headerlink" title="2.2 Promise.prototype.then"></a>2.2 Promise.prototype.then</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">promise.then(onFulfilled, onRejected)</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://promisesaplus.com/">Promise/A+</a> 是Promise的标准规范，<strong>其中指出Promise实例只需要实现then一个方法</strong></li>
<li>then接收两个参数，而两个参数都是可选的，意味着可以什么都不传</li>
<li>then是可以调用多次的。会按顺序调用，并且每次得到的promise状态和值都是相同的</li>
<li>每次调用then均返回一个全新的Promise实例，这样就可以链式调用</li>
<li>then会在当前宏任务下形成一个微任务（具体介绍看下面）</li>
</ul>
<h3 id="2-2-1-promise的状态"><a href="#2-2-1-promise的状态" class="headerlink" title="2.2.1 promise的状态"></a>2.2.1 promise的状态</h3><p>then其实和Promise的构造函数是类似的，返回值都是一个新的Promise实例。</p>
<p>它们之前的差异在于，通过构造函数生成的promise的状态，由构造函数自身决定：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">	resolve(<span class="number">1</span>) <span class="comment">// 将当前的状态流转成resolved</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>而then返回的promise的状态判断需要分两步走：</p>
<ol>
<li>then的回调函数能否处理上一个promise的状态，否则直接复用上一个promise的状态</li>
<li>若满足条件1，则看当前回调函数能否正常处理</li>
</ol>
<p>说得有点绕口，看下面的实例代码即可理解：</p>
<p><strong>理解条件1：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; <span class="comment">// Promise &#123;&lt;rejected&gt;: &quot;error1&quot;&#125;</span></span><br><span class="line">	reject(<span class="string">&#x27;error1&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p2 = p1.then(<span class="built_in">console</span>.log) <span class="comment">// Promise &#123;&lt;rejected&gt;: &quot;error1&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<p>由于<code>p1</code>的状态是<code>Rejected</code>的，而<code>p2</code>没有传入<code>onRejected</code>的回调函数，因此<code>p2</code>的状态完全复用<code>p1</code>的状态。</p>
<p><strong>理解条件2：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; <span class="comment">// Promise &#123;&lt;fulfilled&gt;: 1&#125;</span></span><br><span class="line">	resolve(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p2 = p1.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123; <span class="comment">// Promise &#123;&lt;rejected&gt;: ReferenceError: x is not defined&#125;</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;p1 was resolved:&#x27;</span>, val)</span><br><span class="line">	<span class="keyword">return</span> x; <span class="comment">// Uncaught referenceError</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p3 = p2.then(<span class="literal">undefined</span>, <span class="function"><span class="params">reason</span> =&gt;</span> <span class="number">1</span>) <span class="comment">// Promise &#123;&lt;fulfilled&gt;: 1&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>p1</code>的状态是<code>fulfilled</code>的，而<code>p2</code>有<code>onFulfilled</code>的回调函数，但是没有正确处理，抛异常了。因此<code>p2</code>的状态变成了<code>rejected</code>，其中的reason为则报错的原因。</p>
<p>而此时<code>p3</code>刚好有<code>onRejected</code>的函数，也能正确处理，最后的返回值则是自己的value，因此<code>p3</code>的状态是<code>fulfilled</code>的。</p>
<h3 id="2-2-2-promise的返回值"><a href="#2-2-2-promise的返回值" class="headerlink" title="2.2.2 promise的返回值"></a>2.2.2 promise的返回值</h3><p>前文也提到，promise的返回值可以是任意合法的JavaScript值，包括了<code>promise</code>，这里重点讲下。</p>
<p>由于promise的返回值决定了当前promise的value，而value是其他的promise时，则说明value是未知的，依赖其他的promise的状态。</p>
<p>同样看看例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">setTimeout</span>(resolve, <span class="number">1000</span>, <span class="number">1</span>)</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">() =&gt;</span> p1)</span><br></pre></td></tr></table></figure>

<p><code>p1</code>是一个简单的定时器promise，在1000ms之后，状态会变成<code>&lt;fulfilled: 1&gt;</code>。</p>
<p>而<code>p2</code>的返回值是<code>p1</code>，因此<code>p2</code>在1000ms之内也是<code>&lt;pending&gt;</code>，同样会在1000ms之后，变成<code>&lt;fulfilled: 1&gt;</code></p>
<h2 id="2-3-Promise-prototype-catch"><a href="#2-3-Promise-prototype-catch" class="headerlink" title="2.3 Promise.prototype.catch"></a>2.3 Promise.prototype.catch</h2><p>虽然catch不是Promise/A+标准的方法，但是也需要提一下，因为这也是常用的方法之一。</p>
<p>其实，catch可以理解成then的一种封装：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">promise.catch(<span class="function"><span class="keyword">function</span> <span class="title">onRejected</span>(<span class="params"></span>) </span>&#123;&#125;) == promise.then(<span class="literal">undefined</span>, <span class="function"><span class="keyword">function</span> <span class="title">onRejected</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="2-4-微任务-microtask"><a href="#2-4-微任务-microtask" class="headerlink" title="2.4 微任务 microtask"></a>2.4 微任务 microtask</h2><p>当前promise的状态变更之后，不是立即执行then方法的。此时引入了 <strong>微任务(microtask)</strong> 的概念。</p>
<p>与之对应的则是 **宏任务(macrotask)**，基本的JavaScript代码则是在一个宏任务里执行的。</p>
<p>也可以通过其他的方式生成宏任务：<code>setTimeout</code>、<code>setInterval</code>；而微任务则可以通过<code>promise.then</code>、<code>Object.observe(已废弃)</code>、<code>MutationObserver</code>生成。</p>
<p>宏任务和微任务的关系则是这样的（此处引入winter老师在《重新前端》画的图）：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/167014f8fe4d4befa1dc6bde5cf43ec4~tplv-k3u1fbpfcp-watermark.image"></p>
<p>即一个宏任务下，是可以有多个微任务的。</p>
<blockquote>
<p>由于微任务的机制是引擎提供的，因此手写Promise的时候，可以用setTimeout来代替。</p>
</blockquote>
<h3 id="2-4-1-解析任务"><a href="#2-4-1-解析任务" class="headerlink" title="2.4.1 解析任务"></a>2.4.1 解析任务</h3><p>分析代码的时候，可以这样分几步走：</p>
<ol>
<li>理想情况下，如果没有任何<code>setTimeout</code>和<code>promise.then</code>的话，则全部在一个宏任务里执行</li>
<li>若出现<code>promise.then</code>，则在当前宏任务生成一个微任务，用于执行<code>promise.then</code></li>
<li>若出现了<code>setTimeout</code>，则添加一个宏任务，重复条件1</li>
</ol>
<p>分析几个例子考验一下：</p>
<p><strong>例子1：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="built_in">console</span>.log, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">    resolve(<span class="number">2</span>)</span><br><span class="line">&#125;).then(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<details><summary><b>正确的输出顺序：</b></summary>
<p>
1、3、2、0
</p>
</details>

<p><strong>例子2：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">Promise</span>.resolve(<span class="number">4</span>).then(<span class="built_in">console</span>.log)</span><br><span class="line">&#125;) <span class="comment">// 省略参数，delay默认为0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">    resolve(<span class="number">2</span>)</span><br><span class="line">&#125;).then(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="built_in">console</span>.log, <span class="number">0</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<details><summary><b>正确的输出顺序：</b></summary>
<p>
8、1、3、2、0、4、5
</p>
</details>

<p>其实，还有<code>async/await</code>相关的题目，如果阅读足够多的话，我再完善吧。</p>
<h1 id="3-手写Promise"><a href="#3-手写Promise" class="headerlink" title="3. 手写Promise"></a>3. 手写Promise</h1><p>其实，看到这里说明你已经掌握了几乎全部关键概念了。剩下的任务就是将这些逻辑翻译成代码。</p>
<p>我在<a target="_blank" rel="noopener" href="https://github.com/LeeJim/word">github</a>写了一份，代码逻辑都算挺清晰的，大家可以去看看。</p>
<p>我建议大家在写之前，再仔细看一下<code>Promise/A+</code>的标准规范，可以结合我的代码一起看。</p>
<p>清晰理解细节之后，再动手写一遍。</p>
<p>如果觉得不错的话，记得给我点赞 + <a target="_blank" rel="noopener" href="https://github.com/LeeJim/word">star</a>。</p>
<p>撒花，感谢阅读！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-23T06:40:56.000Z" title="5/23/2020, 2:40:56 PM">2020-05-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:40:56.000Z" title="5/23/2020, 2:40:56 PM">2020-05-23</time></span><span class="level-item">7 minutes read (About 984 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/23/mini-program/update/">自动更新机制</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>小程序的更新机制与它的运行机制有关。</p>
<p>为了保证用户能尽可能快得打开小程序，只会在后台更新，不会主动等待更新完毕才进入最新版小程序。</p>
<h2 id="运行机制"><a href="#运行机制" class="headerlink" title="运行机制"></a>运行机制</h2><p>首先，先看下小程序的运行机制：</p>
<p><img src="/images/update/work-flow.png"></p>
<p>与APP的概念有些类似，初次打开即为冷启动，若启动之后，在被系统回收之前再次打开，则称之为热启动。</p>
<h2 id="更新机制"><a href="#更新机制" class="headerlink" title="更新机制"></a>更新机制</h2><p>小程序的更新机制分为：</p>
<ul>
<li>未启动时更新</li>
<li>启动时更新</li>
</ul>
<p><strong>未启动时更新</strong>：意味着微信客户端会在用户不在访问小程序期间，主动触发更新，最慢24小时内覆盖所有用户。如果用户在未覆盖期间进入小程序，则触发了启动时更新。</p>
<p><strong>启动时更新</strong>：用户冷启动进入小程序时，均会检测小程序是否有更新版本，若有则后台默默更新，准备为下次冷启动时使用。需要注意的是，此时访问的仍是旧版本的小程序。如果此时想手动使用新版小程序，则可以使用官方API：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> updateManager = wx.getUpdateManager()</span><br><span class="line"></span><br><span class="line">updateManager.onCheckForUpdate(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 请求完新版本信息的回调</span></span><br><span class="line">  <span class="built_in">console</span>.log(res.hasUpdate)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">updateManager.onUpdateReady(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  wx.showModal(&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;更新提示&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;新版本已经准备好，是否重启应用？&#x27;</span>,</span><br><span class="line">    <span class="function"><span class="title">success</span>(<span class="params">res</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (res.confirm) &#123;</span><br><span class="line">        <span class="comment">// 新的版本已经下载好，调用 applyUpdate 应用新版本并重启</span></span><br><span class="line">        updateManager.applyUpdate()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">updateManager.onUpdateFailed(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 新版本下载失败</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如若用户是第一次打开小程序（即新用户），则会直接打开最新版本的小程序。此时不需要考虑更新机制。</p>
</blockquote>
<p>根据微信提供的能力，小程序的更新流程大致如下：</p>
<p><img src="/images/update/update-logic.jpg"></p>
<p>由于官方API没有提供主动下载新版本小程序的能力，仅提供了检测的能力。因此，当新版本下载失败时，没法主动触发重试，只能让用户继续访问旧版本的小程序。</p>
<p>下载失败之后，小程序的重试机制不得而知。可能需要等待小程序被销毁之后，再次冷启动时才会再次主动更新；又或者等待24小时之后。</p>
<p>由于可能存在下载新版本失败的用户，因此小程序的后端服务需要考虑向后兼容。另外，可以在下载失败的回调函数里加入数据统计，用于计算更新失败的概率。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>更新机制的测试工作比较麻烦，因为可能要上生产环境测试，风险极大。</p>
<p>笔者尝试在体验版上做测试：先打开<code>v0.0.1</code>版本的小程序，然后在开发者工具上传新的版本，再通过最近访问的列表里再次打开小程序，结果发现直接打开的就是<code>v0.0.2</code>，根本没有还原小程序的更新机制。</p>
<p>因此可以得出结论：<strong>体验版无法测试更新机制</strong>。</p>
<h3 id="模拟更新"><a href="#模拟更新" class="headerlink" title="模拟更新"></a>模拟更新</h3><p>另外，开发者工具的编译模式提供模拟更新：</p>
<p><img src="/images/update/mock-update.jpg"></p>
<h2 id="兼容处理"><a href="#兼容处理" class="headerlink" title="兼容处理"></a>兼容处理</h2><p>由于存在用户访问旧版小程序的可能，因此与后端的接口设计需要特别关注，尤其是在更新接口时，如果没有做到向后兼容，则会出现旧前端访问新后端的现象，从而产生不可预期的后果。</p>
<p>最简单的方式：每次升级接口时，均采用新接口。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-23T06:40:41.000Z" title="5/23/2020, 2:40:41 PM">2020-05-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:40:41.000Z" title="5/23/2020, 2:40:41 PM">2020-05-23</time></span><span class="level-item">12 minutes read (About 1872 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/23/mini-program/thinking-about-components/">组件封装的思考</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在小程序开发的早期，是没有 **自定义组件(component)**，仅有 <strong>自定义模板(template)</strong> 的。最早接触到组件开发还是在使用 <code>React</code>、<code>Vue</code> 框架的时候，熟悉以上两个框架的读者，对小程序的组件应该会有熟悉的感觉，机制和写法差不多</p>
<h2 id="为什么要有组件？"><a href="#为什么要有组件？" class="headerlink" title="为什么要有组件？"></a>为什么要有组件？</h2><p>对于这个问题，很多人的第一反应也许是：代码复用</p>
<p>的确，代码复用是组件的核心职责，但它还有更大的使命：性能</p>
<p>因为通过组件封装，可以将页面拆分成多个组件，因此较大粒度的页面就被拆分成粒度较小的组件。当一些数据发生变更导致页面变化时，就只需要重新渲染包含该数据的组件即可，而不用渲染整个页面，从而达到了提高渲染性能的效果</p>
<p><img src="/images/components/components-graph.png"></p>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p>在 <code>Vue</code> 中，每个页面是一个 <code>Vue</code> 实例，而组件又是可复用的 <code>Vue</code> 实例，因此可以理解成，页面和组件是相同的生命周期</p>
<p>而小程序就将页面和组件拆分成两个类：<code>Page</code> 和 <code>Component</code>，因此接收的生命周期函数也是不一样的。比如，<code>Page</code> 接收的是：<code>onLoad</code>、<code>onShow</code>、<code>onReady</code>等函数，而 <code>Component</code> 则接收 <code>created</code>、<code>attached</code>、<code>ready</code> 等函数</p>
<blockquote>
<p>命名风格都不一致，真是让人头大</p>
</blockquote>
<p><img src="/images/components/miniprogram-lifecycle.png"></p>
<h2 id="数据传递"><a href="#数据传递" class="headerlink" title="数据传递"></a>数据传递</h2><h3 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h3><p><code>Vue</code> 的组件间数据传递的机制是这样的：父组件通过<code>property</code>传递数据给子组件，而子组件通过事件通知的形式传递数据给父组件</p>
<p>在页面包含的组件结构还比较简单的时候，这样的机制还是比较好用的。但是，随着业务的复杂度逐渐上升，组件嵌套的层数递增，会出现数据层层传递的困境</p>
<p>为了解决这个问题，<code>Vue</code> 推出了 <code>Vuex</code> 这样的状态管理工具，集中式存储、管理应用的所有组件的状态。并提出了“单向数据流”的理念：</p>
<p><img src="/images/components/vuex.png"></p>
<h3 id="小程序"><a href="#小程序" class="headerlink" title="小程序"></a>小程序</h3><p>小程序同样有类似的机制，<code>property</code>和事件。此外还提供了获取 <strong>子组件实例</strong> 的方法：<code>selectComponent()</code> 和  定义组件间关系的字段 <code>relations</code></p>
<p>其中常用的就是获取子组件实例，比如:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent-component</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">child-component</span> <span class="attr">id</span>=<span class="string">&quot;child&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">child-component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent-component</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此时，在<code>parent-component</code>组件中可以直接获取<code>child-component</code>的实例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Component(&#123;</span><br><span class="line">    <span class="function"><span class="title">attached</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> $child = <span class="built_in">this</span>.selectComponent(<span class="string">&#x27;#child&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// $child.doSomeThing()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><blockquote>
<p>制作一个 <strong>对话框(modal)</strong> 组件</p>
</blockquote>
<p>也许有的读者会感到困惑，官方不是有提供 <code>wx.showModal</code> 可以直接用吗，为什么要重复造轮子</p>
<p>其实，当你的产品想要结合 <code>Modal</code> 和 <code>Button</code> 的 <code>open-type</code> 能力时，你就会明白重复造轮子的必要性以及<code>wx.showModal</code>的局限性</p>
<h3 id="属性定义"><a href="#属性定义" class="headerlink" title="属性定义"></a>属性定义</h3><p>对话框的常见属性可以参考<code>wx.showModal</code></p>
<p>除此以外，其中关键的一个属性就是 表示对话框当前的显示状态：<code>visible</code></p>
<p>此时，有两种选择，第一种是将这个变量存在页面上，通过<code>property</code>传递给<code>Modal</code>组件；另外一种，就是作为<code>Modal</code>组件<code>data</code>中的一员</p>
<h3 id="property传递"><a href="#property传递" class="headerlink" title="property传递"></a>property传递</h3><p>通过<code>property</code>传递的话，就相当于将 <code>Modal</code> 的控制权交到对应的页面，举例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- home.wxml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">modal</span> <span class="attr">visible</span>=<span class="string">&quot;&#123;&#123;visible&#125;&#125;&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// home.js</span></span><br><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">visible</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">toggleModal</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setData(&#123; <span class="attr">visible</span>: !<span class="built_in">this</span>.data.visible &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>此时对应的 <code>Modal</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// modal.js</span></span><br><span class="line"></span><br><span class="line">Component(&#123;</span><br><span class="line">    <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">visible</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="built_in">Boolean</span>,</span><br><span class="line">            <span class="attr">value</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="function"><span class="title">observer</span>(<span class="params">newVal, oldVal</span>)</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.setData(&#123; <span class="attr">visible</span>: newVal &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里和<code>Vue</code>框架有个差异，<code>Vue</code>对于传进来的property会自动赋值，而小程序则需要自己手动赋值</p>
</blockquote>
<h4 id="问题与办法"><a href="#问题与办法" class="headerlink" title="问题与办法"></a>问题与办法</h4><p>当 <code>visible</code> 这个变量被 <code>Modal</code> 和 <code>Page</code> 同时使用时，会出现不显示的问题。</p>
<p>为了便于描述，我通过描述真实场景来讲解：</p>
<ol>
<li>当页面需要显示对话框时，<code>Page</code> 传递 <code>visible=true</code> 给 <code>Modal</code></li>
<li>经过一段时间之后，用户关闭了对话框，此时 <code>Modal</code> 将自身的 <code>visible</code> 设置为 <code>false</code></li>
<li>当页面需要再次出现对话框时，<code>Page</code> 继续传递<code>visible=true</code> 给 <code>Modal</code>，<strong>此时发现对话框不会显示</strong></li>
</ol>
<p>通过分析可以发现，由于 <code>Page</code> 两次传递相同的 <code>visible=true</code> 给 <code>Modal</code> ，因此第二次传递的时候，被 <code>Modal</code> 直接忽略掉了。</p>
<p>这个问题也很好解决，大致思路就是保证每次传递的值不同即可：</p>
<ul>
<li>传递的值前面加上时间戳，组件再将时间戳移除（比较直观，但是不方便）</li>
<li>利用对象不相等的机制，数据传递只传对象，不传基础数据类型（比如<code>&#123; visible: true &#125; !== &#123; visible: true &#125;</code>)</li>
</ul>
<h3 id="组件自身属性"><a href="#组件自身属性" class="headerlink" title="组件自身属性"></a>组件自身属性</h3><p>这种是我推荐的方案。将 <code>visible</code> 属性交由组件 <code>Modal</code> 自行管理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// modal.js</span></span><br><span class="line"></span><br><span class="line">Component(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">visible</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">methods</span>: &#123;</span><br><span class="line">        <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setData(&#123; <span class="attr">visible</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>由于父组件或者当前页面可以直接获取组件的实例，因此可以直接调用组件的<code>setData</code>，如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> $modal = <span class="built_in">this</span>.selectComponent(<span class="string">&#x27;#modal&#x27;</span>)</span><br><span class="line"></span><br><span class="line">$modal.setData(&#123; <span class="attr">visible</span>: <span class="literal">true</span> &#125;)</span><br></pre></td></tr></table></figure>

<p>但是不建议这样使用，而是组件暴露方法让外部调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> $modal = <span class="built_in">this</span>.selectComponent(<span class="string">&#x27;#modal&#x27;</span>)</span><br><span class="line"></span><br><span class="line">$modal.show()</span><br></pre></td></tr></table></figure>

<h3 id="组件的事件"><a href="#组件的事件" class="headerlink" title="组件的事件"></a>组件的事件</h3><p>通常，对话框都会有按钮，一个或两个。</p>
<p>因此 <code>Modal</code> 需要与父组件通过 <strong>事件(event)</strong> 的方式传递信息：当前点击了取消还是确定按钮：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- home.wxml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">modal</span> <span class="attr">id</span>=<span class="string">&quot;modal&quot;</span> <span class="attr">bind:btntap</span>=<span class="string">&quot;handleModalTap&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// home.js</span></span><br><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">showModal</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> $modal = <span class="built_in">this</span>.selectComponent(<span class="string">&#x27;#modal&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        $modal.show()</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他方法</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">handleModalTap</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; type &#125; = e.detail</span><br><span class="line"></span><br><span class="line">        <span class="comment">// type = cancel or confirm</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在 <code>Modal</code> 的构造函数则是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// modal.js</span></span><br><span class="line"></span><br><span class="line">Component(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">visible</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">methods</span>: &#123;</span><br><span class="line">        <span class="function"><span class="title">handleBtnTap</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> &#123; type &#125; = e.target.dataset</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.triggerEvent(<span class="string">&#x27;btntap&#x27;</span>, &#123; type &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- modal.wxml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;wrapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 省略其他结构 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;foot&quot;</span> <span class="attr">bindtap</span>=<span class="string">&quot;handleBtnTap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">data-type</span>=<span class="string">&quot;cancel&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">data-type</span>=<span class="string">&quot;confirm&quot;</span>&gt;</span>确定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样设计 <code>Modal</code> 组件，的确可以满足使用，但是不够好用</p>
<p>因为展示对话框时使用的是 <code>showModal</code> 而用户操作之后又是通过另外一个方法 <code>handleModalTap</code> 反馈的。当一段时间之后回看这样的代码，会发现这种写法存在思维的中断，不利于代码维护</p>
<p>所以，我建议结合 <code>Promise</code> 来封装 <code>Modal</code></p>
<h3 id="省略事件"><a href="#省略事件" class="headerlink" title="省略事件"></a>省略事件</h3><p>由于展示对话框之后，用户必然要操作，因此可以在 <code>showModal</code> 的时候，通过 <code>Promise</code> 返回对应的操作信息即可</p>
<p>另外，需要引入发布订阅机制（以下使用 <code>Node.js</code> 的 <code>Events</code> 举例）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// modal.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ee = <span class="keyword">new</span> EventEmitter();</span><br><span class="line"></span><br><span class="line">Component(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">visible</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">methods</span>: &#123;</span><br><span class="line">        <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setData(&#123; <span class="attr">visible</span>: <span class="literal">true</span> &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                ee.on(<span class="string">&#x27;cancel&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    reject()</span><br><span class="line">                &#125;)</span><br><span class="line">                ee.on(<span class="string">&#x27;confirm&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    resolve()</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">handleBtnTap</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> &#123; type &#125; = e.target.dataset</span><br><span class="line"></span><br><span class="line">            ee.emit(type)</span><br><span class="line">            <span class="built_in">this</span>.triggerEvent(<span class="string">&#x27;btntap&#x27;</span>, &#123; type &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>此时，在 <code>Page</code> 即可这样展示对话框：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// home.js</span></span><br><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> $modal = <span class="built_in">this</span>.selectComponent(<span class="string">&#x27;#modal&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        $moda.show().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 当点击确认时</span></span><br><span class="line">        &#125;).catch(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 当点击取消时</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>组件是很好用的机制，也是最常用到的能力。因此日常开发中，应该会遇到各种各样组件封装的问题，平时遇到应该多思考总结一下，对团队和自己都很有帮助！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-23T06:40:26.000Z" title="5/23/2020, 2:40:26 PM">2020-05-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:40:26.000Z" title="5/23/2020, 2:40:26 PM">2020-05-23</time></span><span class="level-item">10 minutes read (About 1431 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/23/mini-program/think-about-subscribe/">订阅消息的思考</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>小程序的早期定位是“即用即走”或者说是“用完即走”。<br>但小程序的运营者却不是这么想的，希望用户尽可能的停留在小程序上，或者“多回来看看”，俗称“拉回流”。<br>让用户回流的关键手段就是 <strong>订阅消息</strong>，通过点击订阅消息，可直接回到小程序。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>早期小程序提供的是 <strong>模板消息</strong>，用户每次点击或者完成支付，都会生成一个<code>formId</code>或者<code>paypay_id</code>，开发者可以通过这个<code>formId</code>给用户发送一次模板消息。</p>
<p>因此，开发者的常规做法：尽可能地在每个按钮上都封装<code>form</code>，用以收集<code>formId</code>；收集的<code>formId</code>并不会使用，而是将它们存到数据库里，在需要拉回流的时候，通过这些<code>formId</code>发送模板消息。</p>
<p>这样会存在几个问题：</p>
<ul>
<li>用户会被莫名的骚扰（因为<code>formId</code>有7天的有效期）</li>
<li>用户收到的模板消息是无预期的（因为<code>formId</code>可以发任意的模板消息）</li>
<li>开发者在每个页面每个可点击区域都封装了<code>form</code>，导致代码混乱</li>
</ul>
<p>为了解决以上问题，小程序团队就采用了 <strong>订阅消息</strong> 来替换 <strong>模板消息</strong>。</p>
<blockquote>
<p>小程序模板消息接口于2020年1月10日下线</p>
</blockquote>
<h2 id="订阅消息的优势"><a href="#订阅消息的优势" class="headerlink" title="订阅消息的优势"></a>订阅消息的优势</h2><p><strong>订阅消息</strong> 与 <strong>模板消息</strong> 相比较，明显的优势：用户对自己将收到的模板消息类型有一定的预期，如：</p>
<p><img src="/images/subscribe/request-subscribe-message.jpg"></p>
<p>另外，<strong>对订阅消息的发送时限不做限制</strong>，即可以在任意时间给用户发送一条模板消息，而不像以前的<code>formId</code>有7天的有效期。</p>
<p>从开发者的角度看：订阅消息是使用接口调用(<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html">wx.requestSubscribeMessage</a>)，不再是以前那样，一定要用<code>Button</code>。<strong>对于代码维护和开发效率来说，都是利好的</strong>。</p>
<p>从代码维护上讲，开发者不用再层层嵌套<code>form</code>了，简化了许多代码；另外，以前模板消息是通过<code>Button</code>封装的，拜托了这层束缚之后，就不用再重置<code>Button</code>的样式了，对于开发效率也是有一定的帮助。</p>
<h3 id="模板消息"><a href="#模板消息" class="headerlink" title="模板消息"></a>模板消息</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">bindsubmit</span>=<span class="string">&quot;addFormId&quot;</span> <span class="attr">report-submit</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;invite-btn&quot;</span> <span class="attr">form-type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line">        邀请好友</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="title">addFormId</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; formId &#125; = e.detail;</span><br><span class="line">        <span class="comment">// save formId</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="订阅消息"><a href="#订阅消息" class="headerlink" title="订阅消息"></a>订阅消息</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;invite-btn&quot;</span> <span class="attr">bindtap</span>=<span class="string">&quot;handleInvite&quot;</span>&gt;</span>邀请好友<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">handleInvite</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        wx.requestSubscribeMessage(&#123;</span><br><span class="line">            <span class="attr">tmplIds</span>: [<span class="string">&#x27;&#x27;</span>] <span class="comment">// 订阅的模板ID</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<blockquote>
<p>但是，订阅消息仍有个小程序通病，有一定的兼容性，需要基础库2.4.4以上才能使用。这也就意味着，2020年1月10日模板消息下线之后，你没法招回停留在基础库2.4.4以下的用户了。</p>
</blockquote>
<h2 id="订阅消息的类型"><a href="#订阅消息的类型" class="headerlink" title="订阅消息的类型"></a>订阅消息的类型</h2><p>以往的模板消息，每次发送消息需要消耗一个<code>formId</code>，而<code>formId</code>有7天的有效期，因此小程序无法召回7天以前的活跃用户。</p>
<p>而订阅消息则提供了两种类型：</p>
<ul>
<li>一次性订阅</li>
<li>长期订阅</li>
</ul>
<p>其中，一次性订阅与以往的模板消息类似，是一次性的，唯一的差异是订阅消息没有限时；而长期订阅则是召回的利器，用户只要订阅过一次，小程序将获得给该用户发送多次消息的能力。</p>
<p>不过，目前长期性订阅消息仅向政务民生、医疗、交通、金融、教育等线下公共服务开放。而且个人主体的小程序没有权限申请。</p>
<h2 id="开发的差异"><a href="#开发的差异" class="headerlink" title="开发的差异"></a>开发的差异</h2><h3 id="小程序端"><a href="#小程序端" class="headerlink" title="小程序端"></a>小程序端</h3><p>以往的模板消息方式，需要前端将每次收集到的<code>formId</code>，上传至后端保存起来。现在，需要做的是，记录一下哪个用户订阅了哪些模板即可，至于订阅的次数，也是需要开发者自行保存的。</p>
<p>另外每次发起消息订阅，都会有弹窗出现：</p>
<p><img src="/images/subscribe/WechatIMG198.jpg"></p>
<p>用户可以勾选“总是保持以上选择，不再询问”，这样下次点击时，就直接授权订阅。</p>
<p>若此后希望小程序重新出现弹框，则是没有办法的。只能在设置页里取消单个订阅消息，或者关闭接收所有订阅消息：</p>
<p><img src="/images/subscribe/WechatIMG199.jpg"></p>
<p>其实就等于将这些设置转移到更深的路径上，但还是保留了用户取消订阅的权利。</p>
<p>如果用户关闭接收所有订阅消息，那么调用<code>wx.requestSubscribeMessage</code>时，会触发<code>fail</code>，并返回如下信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">errCode</span>: <span class="number">20004</span>,</span><br><span class="line">    <span class="attr">errMsg</span>: <span class="string">&#x27;The main switch is switched off&#x27;</span>,</span><br><span class="line">    <span class="comment">// 用户关闭了主开关，无法进行订阅</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>订阅消息是模板消息的进阶产品，对于用户、开发者更友好，但对于小程序的运营者来说，反而并没有更大的帮助。毕竟以往<code>formId</code>的方式，可以用来发送任意模板消息，现在只能“特定订阅特定使用”。</p>
<p>因此，更多的小程序运营者会讲小程序的用户引导到公众号，这样才能更大可能地接触到用户，毕竟公众号的消息推送更不受限制。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-23T06:39:16.000Z" title="5/23/2020, 2:39:16 PM">2020-05-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:39:16.000Z" title="5/23/2020, 2:39:16 PM">2020-05-23</time></span><span class="level-item">7 minutes read (About 1009 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/23/mini-program/global-data-manage/">全局变量的管理</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>在浏览器的环境下有一个全局变量：<code>window</code>。<br>若定义变量时，遗漏了<code>var</code>，此时声明的变量就变成了全局变量，自动挂载到<code>window</code>下，可当做<code>window</code>的属性来访问，也可以直接访问。</p>
</blockquote>
<p>小程序的底层也是通过Web实现的，因此同样存在<code>window</code>对象，但是微信团队做了些处理：</p>
<p><img src="/images/global-window.png"></p>
<p>微信团队将<code>window</code>设置成了<code>writable:false</code>，且值也为<code>undefined</code>。</p>
<p>即我们无法像在<code>web</code>那样任意声明全局变量。但微信团队提供了其他的全局变量，比如常用的<code>wx</code>、<code>global</code>。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>虽然<code>window</code>是只读的，但是<code>global</code>是可写的:</p>
<p><img src="/images/global-global.png"></p>
<p>因此常见的做法，就是将需要全局访问的变量都保存到<code>global</code>下，间接声明了全局变量。</p>
<p>全局变量的污染，在小团队的项目里可能没什么感知。但是在一个大型的项目里，是非常常见的，一不小心就将别人声明的变量覆盖了。</p>
<p>另外如果可以随意注册全局变量，又不加以管理的话，有可能会导致内存泄漏，最终导致应用闪退。</p>
<blockquote>
<p>同理，setStorage也存在同样的问题。</p>
</blockquote>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>简单地将这些变量改成<code>readonly</code>肯定是不可取的，这影响了日常的开发。</p>
<p>在早期的前端开发中，也有同样类似的全局变量污染的问题，我依稀记得两种解决方案：</p>
<ul>
<li>命名空间</li>
<li>模块化</li>
</ul>
<p>其中 <strong>模块化</strong> 明显不是这个问题的解决方案。因为目前的确是需要全局变量的，问题只是如何避免污染和管理全局变量而已。</p>
<p>因此 <strong>命名空间</strong> 是可以深入探索的思路。</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><p>命名空间是一种常用的代码组织形式。</p>
<p>大致做法是，先通过命名分配空间，再使用空间。</p>
<blockquote>
<p>我的习惯是，用业务或者功能来命名空间</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">global</span>.localStorage = &#123;</span><br><span class="line">    <span class="function"><span class="title">doSet</span>(<span class="params"></span>)</span> &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="title">doGet</span>(<span class="params"></span>)</span> &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="title">doClear</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">global</span>.util = &#123;</span><br><span class="line">    <span class="function"><span class="title">format</span>(<span class="params"></span>)</span> &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="title">valide</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>命名空间是通过互相约定的方式来工作的，因此仍然会存在覆盖的问题。</p>
<h3 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h3><p><code>Symbol</code>是ES2015中新增的基本数据类型。这个类型有个特别之处，每个<code>Symbol()</code>返回的值都是独一无二的，举个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Symbol</span>(<span class="string">&#x27;foo&#x27;</span>) === <span class="built_in">Symbol</span>(<span class="string">&#x27;foo&#x27;</span>) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>因此通过<code>Symbol</code>的方式，可以完美避免变量被覆盖：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// car.js</span></span><br><span class="line"><span class="keyword">let</span> car = <span class="built_in">Symbol</span>()</span><br><span class="line"><span class="built_in">global</span>[car] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// health.js</span></span><br><span class="line"><span class="keyword">let</span> health = <span class="built_in">Symbol</span>()</span><br><span class="line"><span class="built_in">global</span>[health] = &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>由于每个<code>Symbol</code>返回的值是唯一的，因此这个<code>Symbol</code>可以单独保存，以便各个文件引用。</p>
<blockquote>
<p>由于 <code>Symbol</code> 属于新特性，因此需要关注下兼容性</p>
</blockquote>
<p><img src="/images/compatibility-symbol.jpg"></p>
<h3 id="管理声明"><a href="#管理声明" class="headerlink" title="管理声明"></a>管理声明</h3><p>通过<code>Symbol</code>的方式解决了变量的污染问题，但仍然无法对全局变量的声明进行管理。</p>
<p>我想到的办法就是给 <code>global</code> 增加个代理，对 <code>global</code> 的任何操作，都先经过代理检测，这样就有了强力的保障。</p>
<p>因此，可以使用新特性：<code>Proxy</code> 来监听 <code>global</code> 的变更，举例说明：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">global</span> = <span class="keyword">new</span> <span class="built_in">Proxy</span>(<span class="built_in">global</span>, &#123;</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">obj, prop, val</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">`<span class="subst">$&#123;prop&#125;</span>: 该属性已定义！`</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 可以做其他策略</span></span><br><span class="line">        <span class="comment">// 或者上报数据，让你知道有哪些人偷偷定义了全局对象</span></span><br><span class="line">        obj[prop] = val</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于 <code>Proxy</code> 属于新特性，因此需要关注下兼容性</p>
</blockquote>
<p><img src="/images/compatibility-proxy.jpg"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>使用 <code>Proxy</code> 之后，能对 <code>global</code> 的各种操作（设置属性，设置原型等13种操作）进行监控，即能避免重复定义变量，也可以很好的管理全局变量，两全其美。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-23T06:38:48.000Z" title="5/23/2020, 2:38:48 PM">2020-05-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:38:48.000Z" title="5/23/2020, 2:38:48 PM">2020-05-23</time></span><span class="level-item">5 minutes read (About 703 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/23/mini-program/frame-design/">小程序框架设计</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>其实说是框架设计，有点“夸大其词”。</p>
<p>实际上是，将在开发当中遇到的问题，统一抽象，通过全局封装的方式解决。而这样封装处理，就称为了我所称的“框架”。</p>
<h2 id="封装Page"><a href="#封装Page" class="headerlink" title="封装Page"></a>封装Page</h2><p>对小程序的<code>Page</code>进行封装，是一个框架的基础，也是解决许多通用问题的利刃。</p>
<p>如每个页面都需要设置分享<code>onShareAppMessage</code>，而分享信息大概率是一致的，那么应该如果有效地处理呢？我想到的最佳实践就是封装<code>Page</code>。</p>
<p>一种方案是，通过<code>Page</code>来定义一个新的<code>Page</code>，如：<code>JPage</code>，然后每个页面不再使用<code>Page</code>注册页面，而是使用<code>JPage</code>。</p>
<p>还有一种更好的方案，也是我所采取的方案：<strong>劫持Page</strong>。以至于不用改变每个页面的注册方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> realPage = Page</span><br><span class="line">Page = <span class="function"><span class="keyword">function</span> <span class="title">Page</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> defaultPageConfig = &#123;</span><br><span class="line">        <span class="function"><span class="title">onShareAppMessage</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;这里有很多有趣的壁纸&#x27;</span>,</span><br><span class="line">                <span class="attr">path</span>: <span class="string">`/pages/index/index`</span>,</span><br><span class="line">                <span class="attr">imageUrl</span>: <span class="string">&#x27;http://resoure.africans.cn/1.jpg&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> realPage(&#123; ...defaultPageConfig, ...obj &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样封装，我们后续可以做很多优化，如抽象通用的方法，举个例子：</p>
<p>如果使用过 <strong>云开发</strong> 的读者，应该知道 <strong>获取集合</strong> 的步骤是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> db = wx.cloud.database()</span><br><span class="line"><span class="keyword">let</span> table = db.collection(<span class="string">&#x27;wallpapers&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>可以将这个 获取集合 的方法抽象成这样:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> getTable = <span class="function">(<span class="params">tableName</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> db = wx.cloud.database()</span><br><span class="line">    <span class="keyword">return</span> db.collection(tableName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将这个方法放在<code>defaultPageConfig</code>里，以后每个页面都可以这样获取集合：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.getTable(<span class="string">&#x27;wallpapers&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>每个小程序都有三种版本：开发版、体验版、正式版。</p>
<p>往往我们会有这样的需要，如不同环境请求不同的服务器。那我们要如何区分这些环境呢？</p>
<p>微信官网提供了 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/account-info/wx.getAccountInfoSync.html">wx.getAccountInfoSync</a>，为了避免在<code>Page</code>对象里冗余太多信息，因此<code>env</code>添加至<code>App</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">App(&#123;</span><br><span class="line">    <span class="attr">env</span>: (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; miniProgram &#125; = wx.getAccountInfoSync()</span><br><span class="line">        <span class="keyword">return</span> miniProgram.envVersion</span><br><span class="line">    &#125;())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是，该API仅支持基础库2.2.2以上版本，以下版本目前没有解决方案</p>
</blockquote>
<p>后续可以这样使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> app = getApp()</span><br><span class="line"><span class="built_in">console</span>.log(app.env) <span class="comment">// develop</span></span><br></pre></td></tr></table></figure>
<h2 id="设备信息"><a href="#设备信息" class="headerlink" title="设备信息"></a>设备信息</h2><p>由于每个用户进入小程序之后，设备信息不可能发生变更。</p>
<p>但在每个<code>Page</code>都封装这个信息会有点冗余，因此可以放进<code>App</code>里：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">App(&#123;</span><br><span class="line">    <span class="function"><span class="title">getSystemInfo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> info = wx.getSystemInfoSync()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.getSystemInfo = <span class="function">() =&gt;</span> info</span><br><span class="line">        <span class="keyword">return</span> info</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>采用了缓存的机制，第一次调用时，调用<code>getSystemInfoSync</code>获取，第二次就直接返回缓存的设备信息了</p>
</blockquote>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-23T06:38:14.000Z" title="5/23/2020, 2:38:14 PM">2020-05-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:38:14.000Z" title="5/23/2020, 2:38:14 PM">2020-05-23</time></span><span class="level-item">5 minutes read (About 684 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/23/mini-program/custom-tabbar/">自定义tabbar</a></h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于打算在首页全屏展示壁纸，但是首页属于tabbar页面之一，会被底部的tabbar遮挡一部分。</p>
<p>因此要考虑使用新特性：自定义tabbar。可以看下前后效果对比：</p>
<p><img src="/images/compare.jpg"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>原本想着自行写个组件渲染即可，但看到官方有提供自定义tabbar，那么就优先使用官方提供的吧。</p>
<p>从 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html#tabBar">小程序的官网文档</a> 可以看到，自定义tabbar依赖基础库2.5.0以上，相关配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;tabbar&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;custom&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置了<code>custom</code>之后，小程序不再渲染原有的tabbar，开始渲染自定义tabbar。</p>
<p>而这个自定义tabbar的组件则需要自己写（感觉好像绕回来了）</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>按照官网文档的描述，在根目录上创建组件的文件夹，命名<code>custom-tab-bar</code>，里面的文件和正常的组件保持一致。</p>
<p>此时就可以将组件的样式和逻辑稍作调整：</p>
<ul>
<li>当进入首页时，背景色改成透明</li>
<li>进入其他页面，背景色改回白色</li>
</ul>
<p>这里需要注意的是，并不是多个页面渲染同个tabbar组件，而是每个页面独自渲染各自的tabbar，但不需要在每个页面的<code>WXML</code>里显式引用。</p>
<h3 id="选中态"><a href="#选中态" class="headerlink" title="选中态"></a>选中态</h3><p>由于每个页面都各自渲染了tabbar组件，而这个组件的初始化时，都将设置第一个tab为选中态。因此存在这样的问题：tabbar如何正确显式当前的选中态？</p>
<p>根据官网的描述，即是提供了接口<code>getTabBar</code>，可以获取tabbar的实例。在当前页面下，手动setData更新选中态（这不就很蠢）</p>
<p>需要在tabbar包含的每个页面的onShow里这样设置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onShow</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">this</span>.getTabBar === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.getTabBar().setData(&#123; <span class="attr">selected</span>: <span class="number">0</span> &#125;) <span class="comment">// 0代表第一个</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此时如果能监听到路由的变化，那么可以统一处理。后续考虑封装个Router</p>
</blockquote>
<h3 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h3><p>为了测试兼容性，我尝试将基础库调至2.5.0以下。此时，自定义tabbar和原有的tabbar都没有渲染。通过多方测试，发现只有去掉<code>custom:true</code>才会恢复渲染tabbar。</p>
<p>所以，如果对兼容性要求比较高的小程序，应该避免这个坑。采取自行实现组件，自行引用的方式实现自定义tabbar。</p>
<blockquote>
<p>如果你知道有什么兼容办法，欢迎和我联系。</p>
</blockquote>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-23T06:37:58.000Z" title="5/23/2020, 2:37:58 PM">2020-05-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:37:58.000Z" title="5/23/2020, 2:37:58 PM">2020-05-23</time></span><span class="level-item">5 minutes read (About 737 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/23/mini-program/custom-navigator/">自定义导航栏</a></h1><div class="content"><p>小程序早期版本（微信客户端6.6.0）仅支持全局设置自定义导航栏。只能统一设置，不能页面单独设置。直到微信客户端7.0.0发布之后，开始支持页面设置自定义导航栏，这让许多大型的小程序逐渐改成自定义导航栏成为了可能。</p>
<blockquote>
<p>自定义导航栏：下图黑色部分导航栏不再默认显示，从而整个手机页面都成为小程序的渲染区域</p>
</blockquote>
<p><img src="/images/custom-navigator/interface.jpg"></p>
<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>最大的作用就是可以全屏展示，如我的小程序可以展示壁纸的真实效果，不再受导航栏限制。</p>
<p><img src="/images/custom-navigator/full-screen.jpeg"></p>
<p>其次，可以客制化导航栏，如在后退按钮旁，新增别的按钮，也可以实现后退监听。</p>
<p>需要注意的是，右上角胶囊按钮无法消除，是永久展示的。因此在自定义导航栏的时候，需要考虑与其对齐。可以通过<code>wx.getMenuButtonBoundingClientRect</code>获取胶囊按钮的布局位置信息。</p>
<h2 id="布局信息"><a href="#布局信息" class="headerlink" title="布局信息"></a>布局信息</h2><p>由于开启自定义导航栏之后，全屏界面可渲染，因此如果要客制化导航栏的话，需要知道导航栏的布局信息。</p>
<p><img src="/images/custom-navigator/navigator.jpg"></p>
<p>如上图所示，以Android为例。较深色部分为 **状态栏(statusBar)**，可以通过<code>wx.getSystemInfo</code>获取系统信息，其中的<code>statusBarHeight</code>即是状态栏的高度。</p>
<p>另外前文也提到了，胶囊按钮的信息可以通过<code>wx.getMenuButtonBoundingClientRect</code>获取。胶囊按钮与状态栏的距离可以这样计算：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> mb = wx.getMenuButtonBoundingClientRect();</span><br><span class="line"><span class="keyword">let</span> sh = wx.getSystemInfoSync().statusBarHeight <span class="comment">// 为getSystemInfo的同步版本</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> distance = mb.top - sh</span><br></pre></td></tr></table></figure>

<p>基于胶囊按钮是在导航栏的中间，因此胶囊按钮距离导航栏的底部距离和上面的<code>distance</code>是一致的。所以，导航栏的高度是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> nh = mb.height + distance * <span class="number">2</span> <span class="comment">// navigatorHeight</span></span><br></pre></td></tr></table></figure>

<p>总计一下，导航栏的布局信息如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> navigator = &#123;</span><br><span class="line">    <span class="attr">top</span>: sh</span><br><span class="line">    <span class="attr">bottom</span>: mb.bottom + distance</span><br><span class="line">    <span class="attr">left</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">right</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">height</span>: mb.height + distance * <span class="number">2</span></span><br><span class="line">    <span class="attr">width</span>: wx.getSystemInfoSync().screenWidth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="兼容问题"><a href="#兼容问题" class="headerlink" title="兼容问题"></a>兼容问题</h2><p>前文提到页面设置导航栏是要求<code>客户端7.0.0以上</code>；</p>
<p>另外计算 <strong>状态栏高度(statusBarHeight)</strong> 需要<code>基础库版本1.9.0</code>以上；</p>
<p>计算胶囊按钮的布局信息<code>wx.getMenuButtonBoundingClientRect</code>则要求<code>基础库2.1.0</code>；</p>
<blockquote>
<p>由于微信客户端7.0.0发布日期是2018.12.22，而此时的最新基础库版本为<code>2.4.3</code></p>
</blockquote>
<p>因此，只要判断当前用户的客户端是否为<code>7.0.0</code>或以上即可。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>由于设置了自定义导航栏，全屏成了渲染区域。因此需要注意<code>position: fixed</code>的元素，此时应该将<code>top</code>对应的数值加上<code>statusBarHeight</code>和<code>navigator.height</code>，才能渲染正确。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-23T06:37:30.000Z" title="5/23/2020, 2:37:30 PM">2020-05-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-23T06:37:30.000Z" title="5/23/2020, 2:37:30 PM">2020-05-23</time></span><span class="level-item">12 minutes read (About 1826 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/05/23/mini-program/code-style-guide/">编码规范的一些思考</a></h1><div class="content"><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>古人常说，无规矩不成方圆。在编程的世界里也同样如此。</p>
<p>从编程语言，到文件的命名，再上升到项目结构都可以提供相关的规范。</p>
<p>然而，规范的落地往往都会晚于项目的启动，因此每个团队都会有历史代码需要处理，这是工程师无法逾越，也是心中无法抹去的痛苦。</p>
<h2 id="现实"><a href="#现实" class="headerlink" title="现实"></a>现实</h2><p>在笔者呆过的团队，似乎都在重蹈覆辙：</p>
<ul>
<li>一开始不重视文档、规范，快速启动，敏捷开发</li>
<li>等团队日益壮大，开始制定规范，而此时已经存在大量的历史遗留的问题代码</li>
<li>由于团队会有些人员变动，因此会出现一些无人认领的孤儿代码</li>
</ul>
<p>如此往复，无形中浪费了许多因修复历史代码而产生的工作量。</p>
<p>笔者认为，有可能是以下几种原因导致这种现象：</p>
<ul>
<li>团队早期人员少，项目急，人力不足</li>
<li>前端开发仍不够成熟，没可落地的完整方案</li>
<li>经验不足，无法意识到规范的重要性</li>
</ul>
<h2 id="范围"><a href="#范围" class="headerlink" title="范围"></a>范围</h2><p>我们常说的代码规范属于编码规范的子集。</p>
<p>笔者理解的编码规范包括一下几种：</p>
<ul>
<li>代码规范</li>
<li>文件规范</li>
<li>项目结构规范</li>
</ul>
<p>其中，<strong>代码规范</strong> 并不是编写有效的代码硬性规定，而是统一代码风格、避免出错的最佳实践。</p>
<p>代码规范往往含有主观性（比如在JavaScript是否需要分号），孰是孰非可以讨论很久，因此建议小范围投票，快速决定，坚决执行即可。</p>
<p><strong>文件规范</strong> 则包含：文件的命名规范，以及文件的类型规范（如图片）。</p>
<p><strong>项目结构规范</strong> 是规范化项目的结构，有利于项目的可读性。</p>
<p>由于篇幅有限，文本将主要阐述 <strong>代码规范</strong> 的制定与落地实施。</p>
<h2 id="前端的特殊性"><a href="#前端的特殊性" class="headerlink" title="前端的特殊性"></a>前端的特殊性</h2><p>若是其他岗位，可能就涉及一种编程语言，因此确定一种代码规范即可。</p>
<p>但是前端，涉及到编程语言相对较多，并且不同框架或者runtime也可能导致不同的语法风格，因此需要覆盖的规范也比较多：</p>
<ul>
<li>编程语言：JavaScript、CSS、HTML</li>
<li>框架：Vue、React、Angular</li>
<li>runtime：Node.js、小程序、浏览器</li>
<li>语法糖：CoffeeScript、TypeScript</li>
</ul>
<p>其中JavaScript是一种极度灵活，约束较少，弱类型的动态编程语言，也是前端开发的主要语言。如果不对编码的风格做一定的约束，必然出现千差万别的风格，虽然都是正确可执行的代码，但这会让代码的可阅读性非常差。</p>
<p>上述的runtime和语法糖都是针对于<code>JavaScript</code>而言，因此确定<code>JavsScript</code>的代码规范是首要任务。</p>
<blockquote>
<p>最好的结果就是每个人写得代码都是一样的。</p>
</blockquote>
<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><p>导致团队的代码规范难以指定的一个很大原因就是无法快速开始。</p>
<p>因此笔者提供一种思路：工具驱动规范(Tool Drive Specification)</p>
<p>通过现有的代码检测工具，反向推到出代码的规范，即有可实施的检测工具，又有了现成的文档，一举两得。</p>
<p>对于<code>JavaScript</code>来说，最强力的代码分析检测工具非<code>ESLint</code>莫属，其涵盖了代码质量和编码风格的检测。</p>
<h3 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a>ESLint</h3><p><img src="/images/code-guide/eslint.png"></p>
<p>ESLint官方有提供一个推荐方案，通过配置文件<code>.eslintrc</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;extends&quot;</span>: <span class="string">&quot;eslint:recommended&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者采用业界比较出名的公司规范也可以，比如：Google、Airbnb。</p>
<p>使用<code>ESlint --init</code>即可开启交互式初始化ESLint配置。</p>
<p>对于不同的runtime、语法糖和框架而言，都可以使用ESLint作为检测工具，其中的差异则是需要依赖不同的第三方插件来扩展检测能力。以下以团队的首选框架<code>Vue</code>举例说明：</p>
<p><code>Vue</code>官方提供了ESLint的插件：<a target="_blank" rel="noopener" href="https://eslint.vuejs.org/">eslint-plugin-vue</a></p>
<p>通过此插件，可以利用ESLint检测<code>.vue</code>文件的<code>&lt;template&gt;</code>和<code>&lt;script&gt;</code>模块，检测语法错误，以及编码风格。同样地，插件也有推荐的配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;extends&quot;</span>: <span class="string">&quot;plugin:vue/vue3-recommended&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;rules&quot;</span>: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>另外，可以在<code>rules</code>里覆盖推荐的规范</p>
</blockquote>
<p>执行检测：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx eslint **/*.&#123;js,vue&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HTMLHint"><a href="#HTMLHint" class="headerlink" title="HTMLHint"></a>HTMLHint</h3><p><img src="/images/code-guide/htmlhint.png"></p>
<p>因为<code>HTML</code>不算真正的编程语言，而是标记语言，因此可以检测的规范不会太多，因此可以手动梳理一便，同时也支持自定义规则。全部的规则：<a target="_blank" rel="noopener" href="https://github.com/htmlhint/HTMLHint/wiki/Rules">HTMLHint Rules</a></p>
<p>通过配置文件<code>.htmlhintrc</code>配置，默认配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;tagname-lowercase&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;attr-lowercase&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;attr-value-double-quotes&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;doctype-first&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;tag-pair&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;spec-char-escape&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;id-unique&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;src-not-empty&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;attr-no-duplication&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;title-require&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行检测：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx htmlhint **/*.html</span><br></pre></td></tr></table></figure>

<h3 id="stylelint"><a href="#stylelint" class="headerlink" title="stylelint"></a>stylelint</h3><p><img src="/images/code-guide/stylelint.png"></p>
<p><code>stylelint</code>是<code>CSS</code>的代码分析工具，类似于<code>ESLint</code>，<code>stylelint</code>也提供了 **标准配置(standard configuration)**，安装方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev stylelint stylelint-config-standard</span><br></pre></td></tr></table></figure>

<p>在项目根目录创建配置文件<code>.stylelintrc.json</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;extends&quot;</span>: <span class="string">&quot;stylelint-config-standard&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行检测：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx stylelint <span class="string">&quot;**/*.css&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="实施方案"><a href="#实施方案" class="headerlink" title="实施方案"></a>实施方案</h2><p>如果只是制定的代码规范文档，但是没有可实施方案，依靠人为的自觉，必然出现不遵守规则的漏网之鱼。因此，必须落地实施方案，拒绝不符合规范的代码合入代码仓库。以<code>GitLab</code>举例：</p>
<p>每个仓库均可设置多个分支，在<code>GitLab</code>上对关键分支（比如<code>master</code>）的权限做严格把控，比如：</p>
<ul>
<li>不允许任何人直接push到关键分支（Allowed to push: No one)</li>
</ul>
<p><img src="/images/code-guide/protect-branch.png"></p>
<ul>
<li>仅允许通过pipeline的 <strong>合并请求(merge requests)</strong> 进行合并</li>
</ul>
<p><img src="/images/code-guide/merge-request.png"></p>
<p>最后在pipeline中添加一个Job：执行以上检测脚本。如果代码有不符合规范，则会直接报错从而终止代码继续合并。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>编码规范的重要性在团队建设的前期，往往容易被忽略，带来的后果是需要消耗更多的时间去掩埋一开始挖的坑。并且在无规范的混沌时期，不同的代码风格导致的代码可读性下降，会无形中加重了开发的负担，降低了开发效率。</p>
<p>另外，需要切记的是，规范文档的落地不一定需要正式的<code>word</code>格式，<code>markdown</code>、<code>html</code>乃至于配置文件的格式都是可以接受的。重要的是代码规范有落地的检测工具。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">Previous</a></div><div class="pagination-next"><a href="/page/2/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/5/">5</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://wx.qlogo.cn/mmhead/PiajxSqBRaEKzztxtaqGaVk8KzgrnxCBJkB6RD6rEqGOicBLVhnzxM7g/0" alt="leejimqiu"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">leejimqiu</p><p class="is-size-6 is-block">Senior Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">44</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">33</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/leejim" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/leejim"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weixin" href="https://developers.weixin.qq.com/community/personal/oCJUsw4DgF0046Dd6X7b5Lm-INBA"><i class="fab fa-weixin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://tdesign.tencent.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TDesign</span></span><span class="level-right"><span class="level-item tag">tdesign.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://tdesign.tencent.com/miniprogram" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TDesign Miniprogram</span></span><span class="level-right"><span class="level-item tag">tdesign.tencent.com</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-06T12:21:28.000Z">2022-01-06</time></p><p class="title"><a href="/2022/01/06/miniprogram-function-property/">小程序自定义组件的函数属性及事件触发</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-17T06:59:13.000Z">2021-01-17</time></p><p class="title"><a href="/2021/01/17/promise/">前端进阶 - Promise原理&amp;宏微任务</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-05-23T06:40:56.000Z">2020-05-23</time></p><p class="title"><a href="/2020/05/23/mini-program/update/">自动更新机制</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-05-23T06:40:41.000Z">2020-05-23</time></p><p class="title"><a href="/2020/05/23/mini-program/thinking-about-components/">组件封装的思考</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-05-23T06:40:26.000Z">2020-05-23</time></p><p class="title"><a href="/2020/05/23/mini-program/think-about-subscribe/">订阅消息的思考</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">January 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/11/"><span class="level-start"><span class="level-item">November 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">October 2017</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">September 2017</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">July 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/05/"><span class="level-start"><span class="level-item">May 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">March 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/02/"><span class="level-start"><span class="level-item">February 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/11/"><span class="level-start"><span class="level-item">November 2016</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/10/"><span class="level-start"><span class="level-item">October 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/09/"><span class="level-start"><span class="level-item">September 2016</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/08/"><span class="level-start"><span class="level-item">August 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/07/"><span class="level-start"><span class="level-item">July 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/05/"><span class="level-start"><span class="level-item">May 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/10/"><span class="level-start"><span class="level-item">October 2015</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/09/"><span class="level-start"><span class="level-item">September 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Array/"><span class="tag">Array</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BFC/"><span class="tag">BFC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Buffers/"><span class="tag">Buffers</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CSS/"><span class="tag">CSS</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ES6/"><span class="tag">ES6</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTML/"><span class="tag">HTML</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTTP/"><span class="tag">HTTP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/History-API/"><span class="tag">History API</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Node-js/"><span class="tag">Node.js</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Session/"><span class="tag">Session</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Storage/"><span class="tag">Storage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cookie/"><span class="tag">cookie</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gulp/"><span class="tag">gulp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/promise-%E5%AE%8F%E4%BB%BB%E5%8A%A1-%E5%BE%AE%E4%BB%BB%E5%8A%A1/"><span class="tag">promise 宏任务 微任务</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tdesign/"><span class="tag">tdesign</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/underscore-js/"><span class="tag">underscore.js</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vue-js/"><span class="tag">vue.js</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%8B%E4%BB%B6/"><span class="tag">事件</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"><span class="tag">内存管理</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0/"><span class="tag">函数</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%87%BD%E6%95%B0%E5%B1%9E%E6%80%A7/"><span class="tag">函数属性</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"><span class="tag">垃圾回收</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"><span class="tag">小程序</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B1%9E%E6%80%A7/"><span class="tag">属性</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/"><span class="tag">模块化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%9B%92%E6%A8%A1%E5%9E%8B/"><span class="tag">盒模型</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/"><span class="tag">编码规范</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"><span class="tag">网络安全</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B7%AF%E7%94%B1/"><span class="tag">路由</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%94%AE%E7%9B%98/"><span class="tag">键盘</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%97%AD%E5%8C%85/"><span class="tag">闭包</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Jim Home" height="28"></a><p class="is-size-7"><span>&copy; 2022 leejimqiu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/leejim"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>